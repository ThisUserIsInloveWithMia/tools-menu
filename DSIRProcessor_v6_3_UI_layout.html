<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>DSIR Processor — Copy Textarea</title>
  <style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
  .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-bottom:12px; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border:1px solid #e3e3e3; padding:6px; font-size:14px; text-align:left; }
  .sep td { background:#f9f9f9; height:8px; border:none; }
</style>
<style>
  /* --- Dropdown design --- */
    #dateFilter {
      padding: 6px 12px;
      border: 2px solid #4f46e5;     /* violet border */
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      margin-left: 10px;
      min-width: 180px;
    }
    #dateFilter:hover {
      border-color: #ff7e00;         /* orange hover */
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #dateFilter:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.3);
    }
/* --- v6.1 Sidebar UI (core-only) --- */
#menuToggle{
  position: fixed; top: 14px; left: 14px; z-index: 10001;
  background: #111; color:#fff; border:none; border-radius:10px; padding:10px 12px; cursor:pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
}
#menuToggle:hover{ transform: translateY(-1px); }
#sideOverlay{
  position: fixed; inset:0; background: rgba(0,0,0,.35);
  opacity:0; visibility:hidden; transition: opacity .25s ease, visibility .25s ease; z-index: 10000;
}
#sideOverlay.open{ opacity:1; visibility:visible; }
#sidebar{
  position: fixed; top:0; left:0; height:100vh; width: 300px;
  background: #ffffff; color:#111; box-shadow: 2px 0 18px rgba(0,0,0,.12);
  transform: translateX(-105%); transition: transform .28s ease; z-index: 10001; display:flex; flex-direction:column;
}
#sidebar.open{ transform: translateX(0); }
#sidebar header{ padding:16px 16px 8px; font-weight:700; font-size:16px; border-bottom:1px solid #eee; }
#sidebar .sub{ color:#666; font-size:12px; padding:0 16px 12px; border-bottom:1px solid #f3f3f3; }
#sidebar .menu{ padding:10px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
.menu .btn{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px;
  background:#fafafa; cursor:pointer; transition: transform .15s ease, background .15s ease; text-align:left;
}
.menu .btn:hover{ background:#f0f0f0; transform: translateX(2px); }
.menu .btn svg{ width:20px; height:20px; }
.menu small{ display:block; color:#666; font-size:11px; margin-top:2px; }
#activeDsirWrap{ padding:10px 16px; font-size:12px; color:#333; border-top:1px solid #f3f3f3; }
#activeDsirLabel{ font-weight:600; }
.modal{
  position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10002;
}
.modal.open{ display:flex; }
.modal .panel{
  width:min(520px, 92vw); background:#fff; border-radius:14px; box-shadow:0 18px 60px rgba(0,0,0,.25);
  padding:16px; max-height:80vh; overflow:auto;
}
.modal .panel h3{ margin:4px 0 10px; }
.modal .panel .foot{ margin-top:14px; display:flex; justify-content:flex-end; gap:10px; }
.modal .panel button{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
</style><style>
/* === DSIR Harvester v6.3 — Modern UI Layout (logic untouched) === */
:root {
  --bg: #f4f6fb;
  --text: #222;
  --muted: #6b7280;
  --panel: #fff;
  --accent: #4f46e5;
  --border: #e5e7eb;
  --success: #16a34a;
  --warn: #f59e0b;
  --danger: #dc2626;
}

html, body {
  margin:0; padding:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
  background: var(--bg);
  color: var(--text);
}

/* Main title */
h1#mainTitle {
  text-align:center;
  font-size:2.2em;
  font-weight:700;
  margin:24px 0 12px;
}

/* Match counters */
#counters {
  display:flex;
  justify-content:center;
  gap:12px;
  margin-bottom:20px;
}
.counter {
  padding:8px 14px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  background: var(--panel);
  border:1px solid var(--border);
  box-shadow: 0 2px 6px rgba(0,0,0,.05);
}
.counter.success{ color:var(--success); border-color: var(--success); }
.counter.warn{ color:var(--warn); border-color: var(--warn); }
.counter.danger{ color:var(--danger); border-color: var(--danger); }

/* Results table */
#resultsCard {
  background: var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  margin:0 auto 30px;
  width:min(1200px, 95%);
  overflow:hidden;
}
#resultsTable {
  width:100%;
  border-collapse:collapse;
}
#resultsTable thead {
  background: var(--accent);
  color:white;
}
#resultsTable th, #resultsTable td {
  padding:10px 14px;
  font-size:14px;
  border-bottom:1px solid var(--border);
}
#resultsTable td:nth-child(2){ text-align:right; font-variant-numeric:tabular-nums; }
#resultsTable tbody tr:nth-child(even){ background:#fafafa; }
#resultsTable tbody tr:hover{ background:#f3f4f6; }

/* Sidebar */
#sidebar {
  background:#111827;
  color:white;
}
#sidebar header {
  font-weight:700;
  font-size:16px;
  padding:18px;
  border-bottom:1px solid #1f2937;
}
#sidebar .sub {
  font-size:12px;
  padding:0 18px 14px;
  color:#9ca3af;
  border-bottom:1px solid #1f2937;
  text-align:center;
}
#sidebar .menu .btn {
  background:rgba(255,255,255,.05);
  border:1px solid #1f2937;
  color:white;
}
#sidebar .menu .btn:hover {
  background:rgba(255,255,255,.12);
}

/* Modals */
.modal .panel {
  background: var(--panel);
  border:1px solid var(--border);
  color:var(--text);
}
.modal .panel h3 {
  margin-top:0;
}
.modal .panel button {
  padding:6px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#f3f4f6;
  cursor:pointer;
}
.modal .panel button:hover{ background:#e5e7eb; }

/* Logs body */
#logsBody {
  background:#f9fafb !important;
  border:1px solid var(--border) !important;
  color:var(--text);
}
#logsBody div { border-bottom:1px dashed var(--border) !important; padding:3px 0; }
#logsBody div:last-child{ border-bottom:0 !important; }
</style><style>
/* === DSIR Harvester v6.3 Polished UI (logic untouched) === */

/* Buttons */
button, .btn {
  background: transparent;
  border: 2px solid var(--accent, #4f46e5);
  color: var(--accent, #4f46e5);
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
}
button:hover, .btn:hover {
  background: var(--accent, #4f46e5);
  color: #fff;
  box-shadow: 0 4px 12px rgba(79,70,229,0.35);
  transform: translateY(-1px);
}

/* Panels and cards */
.card, .panel {
  background: var(--panel, #fff);
  border: 1px solid var(--border, #e5e7eb);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

/* Modals */
.modal .panel {
  max-width: 700px;
  margin: auto;
}

/* Results Table */
#resultsCard {
  margin: 0 auto 30px;
  width: min(1200px, 95%);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
}
#resultsTable {
  width: 100%;
  border-collapse: collapse;
}
#resultsTable thead {
  background: var(--accent, #4f46e5);
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 1;
}
#resultsTable th, #resultsTable td {
  padding: 12px 16px;
  font-size: 14px;
  border-bottom: 1px solid var(--border, #e5e7eb);
}
#resultsTable tbody tr:nth-child(even) {
  background: #f9fafb;
}
#resultsTable tbody tr:hover {
  background: #eef2ff;
}

/* Counters */
.counter {
  border: 2px solid var(--border, #e5e7eb);
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.25s ease;
}
.counter.success { border-color: #16a34a; color: #16a34a; }
.counter.warn { border-color: #f59e0b; color: #f59e0b; }
.counter.danger { border-color: #dc2626; color: #dc2626; }
.counter.show { opacity: 1; visibility: visible; }

/* Sidebar */
#sidebar {
  background: #111827;
  color: #fff;
}
#sidebar header {
  font-weight: 700;
  font-size: 16px;
  padding: 18px;
  border-bottom: 1px solid #1f2937;
}
#sidebar .sub {
  font-size: 12px;
  padding: 0 18px 14px;
  color: #9ca3af;
  border-bottom: 1px solid #1f2937;
  text-align: center;
}
#sidebar .menu .btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid #1f2937;
  color: #fff;
}
#sidebar .menu .btn:hover {
  background: rgba(255,255,255,0.15);
}

/* Logs and About Modals */
#logsBody, #aboutModal .panel {
  background: #f9fafb;
  border: 1px solid var(--border, #e5e7eb);
  color: var(--text, #111);
}
</style></head>
<body><button id="menuToggle">☰ Menu</button>
<h1 id="mainTitle" style="text-align:center; font-size:2em; font-weight:700; margin:20px 0;">DSIR Processor</h1><div id="counters"><div class="counter success" id="exactBadge"></div><div class="counter warn" id="fuzzyBadge"></div><div class="counter danger" id="unmatchedBadge"></div></div>
<div class="card">
<div class="row">
<input accept=".csv" id="csvFile" type="file"/>
<button id="processBtn">Process</button><select id="dateFilter" style="margin-left:10px; min-width:180px;"><option disabled="True" selected="True" value="">— Select date —</option></select>
<button disabled="" id="downloadBtn">Download Excel</button>
<button disabled="" id="copyBtn">Copy Sales Column</button>
</div>
</div>
<div class="card">
<div class="row">
<div>DSIR rows: <b id="dsirCount"></b></div>
<div>Exact matches: <b id="matchCount"></b></div>
<div>Fuzzy matches: <b id="fuzzyCount"></b></div>
<div>Excluded: <b id="excludedCount"></b></div>
<div>Unmatched: <b id="unmatchedCount"></b></div>
</div>
<div style="max-height:60vh; overflow:auto;">
<table id="outTable">
<thead>
<tr><th style="width:140px;">Code</th><th style="width:160px;">Category</th><th>Product</th><th style="width:120px;">Sales</th><th style="width:80px;"> </th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const DSIR = [{"type": "product", "code": "600003", "category": "BREADS", "product": "Asado roll"}, {"type": "product", "code": "600004", "category": "BREADS", "product": "Asado square"}, {"type": "product", "code": "600005", "category": "BREADS", "product": "CHEESE BREAD x6"}, {"type": "product", "code": "600007", "category": "BREADS", "product": "Baked chicken empanada"}, {"type": "product", "code": "600008", "category": "BREADS", "product": "Braided ham"}, {"type": "product", "code": "600009", "category": "BREADS", "product": "Brown sugar raisin"}, {"type": "product", "code": "600011", "category": "BREADS", "product": "Cheese bites"}, {"type": "product", "code": "600012", "category": "BREADS", "product": "Double Cheese Bread x4"}, {"type": "product", "code": "600013", "category": "BREADS", "product": "Cheese roll"}, {"type": "product", "code": "690022", "category": "BREADS", "product": "Coffee bavarian bun"}, {"type": "product", "code": "600016", "category": "BREADS", "product": "Coffee roti roll"}, {"type": "product", "code": "", "category": "BREADS", "product": "Cream Bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "Creamy enzaimada"}, {"type": "product", "code": "", "category": "BREADS", "product": "Custard cream bun"}, {"type": "product", "code": "", "category": "BREADS", "product": "Enzaimada bites"}, {"type": "product", "code": "", "category": "BREADS", "product": "Enzaimada rolls"}, {"type": "product", "code": "", "category": "BREADS", "product": "Flossy meat roll"}, {"type": "product", "code": "", "category": "BREADS", "product": "Four Seasons"}, {"type": "product", "code": "", "category": "BREADS", "product": "Garlic bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "HAM & QUESO"}, {"type": "product", "code": "", "category": "BREADS", "product": "Ham salad bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "Hongkong milk bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "Hotdog with cheese"}, {"type": "product", "code": "", "category": "BREADS", "product": "Malunggay cheese pandesal"}, {"type": "product", "code": "", "category": "BREADS", "product": "Malunggay tuna"}, {"type": "product", "code": "", "category": "BREADS", "product": "Milky baby pandesal"}, {"type": "product", "code": "", "category": "BREADS", "product": "Milky ube roll"}, {"type": "product", "code": "", "category": "BREADS", "product": "Premium Cheese Bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "Mongo loaf"}, {"type": "product", "code": "", "category": "BREADS", "product": "Mongo roll"}, {"type": "product", "code": "", "category": "BREADS", "product": "Coco cluster x6"}, {"type": "product", "code": "", "category": "BREADS", "product": "Pandecoco"}, {"type": "product", "code": "", "category": "BREADS", "product": "Pineapple delight"}, {"type": "product", "code": "", "category": "BREADS", "product": "SET1 BM5 (m.w.f)"}, {"type": "product", "code": "", "category": "BREADS", "product": "SET2 CE5"}, {"type": "product", "code": "610000", "category": "BREADS", "product": "SET 3 CE2,BMP3(m.w.f)"}, {"type": "product", "code": "", "category": "BREADS", "product": "SET 4 FS1,CRR2,MR2"}, {"type": "product", "code": "", "category": "BREADS", "product": "SET5 BS2,MR1,US2"}, {"type": "product", "code": "610006", "category": "BREADS", "product": "Hopia Mongo"}, {"type": "product", "code": "610007", "category": "BREADS", "product": "Hopia Ube"}, {"type": "product", "code": "610009", "category": "BREADS", "product": "Hopia Container"}, {"type": "product", "code": "610010", "category": "BREADS", "product": "Mochi Bread x6"}, {"type": "product", "code": "", "category": "BREADS", "product": "Special mongo bun"}, {"type": "product", "code": "610011", "category": "BREADS", "product": "Special pandesal x9"}, {"type": "product", "code": "610014", "category": "BREADS", "product": "Ube enzaimada single"}, {"type": "product", "code": "610017", "category": "BREADS", "product": "Ube macapuno loaf"}, {"type": "product", "code": "", "category": "BREADS", "product": "Ube munchies"}, {"type": "product", "code": "", "category": "BREADS", "product": "Ube queso pandesal"}, {"type": "product", "code": "610019", "category": "BREADS", "product": "Ube stick"}, {"type": "product", "code": "", "category": "BREADS", "product": "Wheat bread"}, {"type": "product", "code": "", "category": "BREADS", "product": "Cheese stick bread"}, {"type": "product", "code": "610021", "category": "BREADS", "product": "Pizzadog"}, {"type": "product", "code": "", "category": "BREADS", "product": "Volcanic Cheese Melt"}, {"type": "product", "code": "", "category": "BREADS", "product": "Pizza round"}, {"type": "product", "code": "", "category": "BREADS", "product": "BABY ENZAIMADA"}, {"type": "product", "code": "", "category": "BREADS", "product": "Spicy Chicken Floss"}, {"type": "product", "code": "620002", "category": "BREADS", "product": "RAISIN & WALNUT SOUR DOUGH"}, {"type": "product", "code": "620003", "category": "BREADS", "product": "Malunggay Pandesal x9"}, {"type": "product", "code": "620004", "category": "BREADS", "product": "Premium Cheese Roll"}, {"type": "product", "code": "620005", "category": "BREADS", "product": "DULCE de UBE"}, {"type": "product", "code": "620008", "category": "BREADS", "product": "CHEESY FLOSSY BAR"}, {"type": "product", "code": "", "category": "BREADS", "product": "UBE MOCHI BREAD"}, {"type": "product", "code": "", "category": "BREADS", "product": "MONGO MOCHI BREAD"}, {"type": "product", "code": "", "category": "BREADS", "product": "DOUBLE MUNCHIES"}, {"type": "product", "code": "", "category": "BREADS", "product": "BAVARIAN MUNCHIES"}, {"type": "product", "code": "", "category": "BREADS", "product": "PINEAPPLE MUNCHIES"}, {"type": "product", "code": "", "category": "BREADS", "product": "RAISIN MINIS"}, {"type": "product", "code": "630000", "category": "BREADS", "product": "CINNAMON ROLLS"}, {"type": "product", "code": "", "category": "BREADS", "product": "Malunggay Cheese Mini"}, {"type": "product", "code": "", "category": "BREADS", "product": "Paborito Breads x10"}, {"type": "product", "code": "", "category": "BREADS", "product": "Craving Breads x 6"}, {"type": "product", "code": "", "category": "BREADS", "product": "HAM AND CHEESE ROLL"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "code": "630007", "category": "PASTRIES", "product": "Banana loaf (New Improved)"}, {"type": "product", "code": "630008", "category": "PASTRIES", "product": "Banana slice"}, {"type": "product", "code": "630010", "category": "PASTRIES", "product": "CHEESY mamon /pc"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Cheese pie"}, {"type": "product", "code": "630013", "category": "PASTRIES", "product": "Chiffon cake"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Choco crinkles"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Choco vanilla"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Flossy chiffon x4"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Fluffy chiffon"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Fudge brownies x12"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Milky egg pie"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Mini cakes x12"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Mocha vanilla"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "S'mores fudge x8"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Sossy flossy roll"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Yema Krema"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Egg Pie Whole"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Fudge brownies Single"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "Macaroons"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "FLUFFY CHIFFON BIG"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "LECHE FLAN CAKE"}, {"type": "product", "code": "640001", "category": "PASTRIES", "product": "Mini Jelly Roll"}, {"type": "product", "code": "", "category": "PASTRIES", "product": "PREMIUM TAISAN BAR"}, {"type": "product", "code": "640003", "category": "PASTRIES", "product": "FLUFFY CHIFFON SMALL"}, {"type": "product", "code": "640005", "category": "CAKES", "product": "Choco Fantasy 6\""}, {"type": "product", "code": "640007", "category": "CAKES", "product": "Choco Fantasy AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Choco Fantasy 8X12\""}, {"type": "product", "code": "", "category": "CAKES", "product": "CHOCOLATE CARAMEL AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "CHOCOLATE CARAMEL 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "CHOCOLATE CARAMEL 8X12\""}, {"type": "product", "code": "", "category": "CAKES", "product": "DOLCE DE LECHE AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "DOLCE DE LECHE 8\""}, {"type": "product", "code": "680004", "category": "CAKES", "product": "DOLCE DE LECHE 8X16\""}, {"type": "product", "code": "680005", "category": "CAKES", "product": "Ivory Bloom 6\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Ivory Bloom 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Ivory Bloom 8X12\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Kitkat Mousse Cake AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Kitkat Mousse Cake 8\""}, {"type": "product", "code": "690016", "category": "CAKES", "product": "MANGO SUPREME AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "MANGO SUPREME 8\""}, {"type": "product", "code": "660006", "category": "CAKES", "product": "MOCHA DRIP AFFORDABLE"}, {"type": "product", "code": "660007", "category": "CAKES", "product": "MOCHA DRIP 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "MOCHALICIOUS AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "MOCHALICIOUS 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "MOCHALICIOUS 8X12\""}, {"type": "product", "code": "", "category": "CAKES", "product": "NUTELLA CAKE AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "NUTELLA CAKE 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "CHOCO DREAM AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Oreo Dream 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "SALTED CARAMEL 6\""}, {"type": "product", "code": "", "category": "CAKES", "product": "SALTED CARAMEL 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Strawberry Shortcake AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Strawberry Shortcake 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Ube Halaya AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Ube Yum 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "UBE LECHE FLAN AFFORDABLE"}, {"type": "product", "code": "690025", "category": "CAKES", "product": "UBE LECHE FLAN 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "Ube Yum 8x12"}, {"type": "product", "code": "", "category": "CAKES", "product": "Yema CAKE AFFORDABLE"}, {"type": "product", "code": "", "category": "CAKES", "product": "Yema Streussel 8\""}, {"type": "product", "code": "", "category": "CAKES", "product": "CHOCO MOCHA DUET"}, {"type": "separator"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ADOBO PEANUT POUCH"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ALMOND JELLY"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ASSTD CANDY/ CHOCOLATES"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ASSTD CHIPS (7 SEAS)"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ASSTD LOLLIPOP"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ASSTD MUSHROOM CHIPS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ASSTD POLVORON X12"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ATSARA"}, {"type": "product", "code": "", "category": "OTHERS", "product": "BANANA CHIPS BIG"}, {"type": "product", "code": "", "category": "OTHERS", "product": "BARQUILLOS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "BARQUILLOS TUB"}, {"type": "product", "code": "", "category": "OTHERS", "product": "BIG OVEN BROWNIES"}, {"type": "product", "code": "", "category": "OTHERS", "product": "CANDY CANE PER PACK"}, {"type": "product", "code": "", "category": "OTHERS", "product": "CARP SARAP"}, {"type": "product", "code": "610025", "category": "OTHERS", "product": "CHARACTER SURPRISE"}, {"type": "product", "code": "610026", "category": "OTHERS", "product": "CHICHA CORN"}, {"type": "product", "code": "610027", "category": "OTHERS", "product": "CHICHA POP"}, {"type": "product", "code": "610028", "category": "OTHERS", "product": "CHICHA POP CON."}, {"type": "product", "code": "610029", "category": "OTHERS", "product": "CHOCO BISCUIT (ORIGO)"}, {"type": "product", "code": "610030", "category": "OTHERS", "product": "CHOCO BISCUIT STICK"}, {"type": "product", "code": "610031", "category": "OTHERS", "product": "CHOCO NIPS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "CHUNKY PEANUT BUTTER"}, {"type": "product", "code": "610032", "category": "OTHERS", "product": "CLASSIC Biscocho"}, {"type": "product", "code": "610033", "category": "OTHERS", "product": "CREAMY APAS"}, {"type": "product", "code": "610035", "category": "OTHERS", "product": "DABOY BITE SIZE"}, {"type": "product", "code": "610037", "category": "OTHERS", "product": "DABOY CHICHARON"}, {"type": "product", "code": "610038", "category": "OTHERS", "product": "DABOY TRAY BACKFAT"}, {"type": "product", "code": "", "category": "OTHERS", "product": "DAILY NUT"}, {"type": "product", "code": "", "category": "OTHERS", "product": "DAILYPLUS ASST."}, {"type": "product", "code": "", "category": "OTHERS", "product": "DARK/RED VELVET CRINKLES"}, {"type": "product", "code": "", "category": "OTHERS", "product": "DILIS CRISPY / SPICY"}, {"type": "product", "code": "620013", "category": "OTHERS", "product": "DILIS MIXED"}, {"type": "product", "code": "620014", "category": "OTHERS", "product": "DINOSAUR EGG BIG"}, {"type": "product", "code": "620015", "category": "OTHERS", "product": "DINOSAUR EGG SMALL"}, {"type": "product", "code": "620016", "category": "OTHERS", "product": "DRIED FRUIT"}, {"type": "product", "code": "620017", "category": "OTHERS", "product": "EGG COINS"}, {"type": "product", "code": "620018", "category": "OTHERS", "product": "EGG CRACKERS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ESPASOL"}, {"type": "product", "code": "", "category": "OTHERS", "product": "EVERYDAY MIX NUTS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "FISH CRACKER SMALL"}, {"type": "product", "code": "630030", "category": "OTHERS", "product": "FLAVORED GARLIC PEANUT"}, {"type": "product", "code": "630031", "category": "OTHERS", "product": "GARLIC PEANUT POUCH"}, {"type": "product", "code": "", "category": "OTHERS", "product": "GOLD COINS POUCH"}, {"type": "product", "code": "", "category": "OTHERS", "product": "GUMMY CANDY ASSTD. POUCH"}, {"type": "product", "code": "630033", "category": "OTHERS", "product": "HAMBURGER SQUISHY"}, {"type": "product", "code": "630034", "category": "OTHERS", "product": "HOPIA KING"}, {"type": "product", "code": "", "category": "OTHERS", "product": "JELLY BEANS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "JUMBO EGG"}, {"type": "product", "code": "", "category": "OTHERS", "product": "JUMBO WHIRL LOLLIPOP"}, {"type": "product", "code": "630035", "category": "OTHERS", "product": "Kiamoy Pouch"}, {"type": "product", "code": "", "category": "OTHERS", "product": "KIKIAM"}, {"type": "product", "code": "630037", "category": "OTHERS", "product": "KROPECK SHRIMP"}, {"type": "product", "code": "", "category": "OTHERS", "product": "LECHE FLAN"}, {"type": "product", "code": "630039", "category": "OTHERS", "product": "LENGUA"}, {"type": "product", "code": "", "category": "OTHERS", "product": "MACARONI CRACKERS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "MIXED NUTS POUCH"}, {"type": "product", "code": "630043", "category": "OTHERS", "product": "MUNCH ASSRTED"}, {"type": "product", "code": "630045", "category": "OTHERS", "product": "NACHOS ASSRTED"}, {"type": "product", "code": "", "category": "OTHERS", "product": "OCEAN SERIES"}, {"type": "product", "code": "", "category": "OTHERS", "product": "OGOY"}, {"type": "product", "code": "", "category": "OTHERS", "product": "OGOY STICK"}, {"type": "product", "code": "", "category": "OTHERS", "product": "OTAP"}, {"type": "product", "code": "640008", "category": "OTHERS", "product": "OTAP NEW"}, {"type": "product", "code": "640009", "category": "OTHERS", "product": "PABORITA SMALL"}, {"type": "product", "code": "640010", "category": "OTHERS", "product": "PACENCIA WHITE"}, {"type": "product", "code": "", "category": "OTHERS", "product": "party lollipop"}, {"type": "product", "code": "", "category": "OTHERS", "product": "PEANUT BAR"}, {"type": "product", "code": "640011", "category": "OTHERS", "product": "PEANUT NOUGAT"}, {"type": "product", "code": "", "category": "OTHERS", "product": "PEANUT POUCH"}, {"type": "product", "code": "650025", "category": "OTHERS", "product": "PILIPIT BIG X10"}, {"type": "product", "code": "650026", "category": "OTHERS", "product": "POTATO CHIPS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "RAINBOW MALLOWS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "RED VELVET BROWNIE"}, {"type": "product", "code": "", "category": "OTHERS", "product": "ROASTED CASHEW"}, {"type": "product", "code": "650028", "category": "OTHERS", "product": "SECO VARIETY"}, {"type": "product", "code": "650029", "category": "OTHERS", "product": "SHRIMP CRACKERS"}, {"type": "product", "code": "", "category": "OTHERS", "product": "SIOPAO SQUISHY"}, {"type": "product", "code": "", "category": "OTHERS", "product": "SMALL MANTOU"}, {"type": "product", "code": "", "category": "OTHERS", "product": "SPECIAL BISCOCHO"}, {"type": "product", "code": "", "category": "OTHERS", "product": "SPECIAL MONGO BEAN"}, {"type": "product", "code": "650030", "category": "OTHERS", "product": "SPECIAL PABORITA"}, {"type": "product", "code": "650031", "category": "OTHERS", "product": "SQUASH SEEDS"}, {"type": "product", "code": "650032", "category": "OTHERS", "product": "SWEET TAMARIND CANDY"}, {"type": "product", "code": "650033", "category": "OTHERS", "product": "TAMARIND CANDY"}, {"type": "product", "code": "", "category": "OTHERS", "product": "TEA EGG"}, {"type": "product", "code": "800002", "category": "OTHERS", "product": "TIKOY HOPIA"}, {"type": "product", "code": "", "category": "OTHERS", "product": "TOAST GARLIC /LESS SUGAR"}, {"type": "product", "code": "", "category": "OTHERS", "product": "TOASTED MAMON"}, {"type": "product", "code": "", "category": "OTHERS", "product": "TOFU ASSORTED FLV."}, {"type": "product", "code": "", "category": "OTHERS", "product": "TORONES POUCH"}, {"type": "product", "code": "", "category": "OTHERS", "product": "TORONES TUB"}, {"type": "product", "code": "", "category": "OTHERS", "product": "URARO"}, {"type": "product", "code": "", "category": "OTHERS", "product": "YEMA MINI PACK"}, {"type": "product", "code": "", "category": "OTHERS", "product": "YEMA TOWER"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "code": "", "category": "ROSALIE", "product": "3n1 KAKANIN"}, {"type": "product", "code": "", "category": "ROSALIE", "product": "ESPASOL"}, {"type": "product", "code": "", "category": "ROSALIE", "product": "KUTSINTA"}, {"type": "product", "code": "", "category": "ROSALIE", "product": "PUTO PAO"}, {"type": "product", "code": "", "category": "ROSALIE", "product": "SUMAN PINIPIG SMALL"}, {"type": "separator"}, {"type": "product", "code": "", "category": "PUTO", "product": "PUTO BIG"}, {"type": "product", "code": "", "category": "PUTO", "product": "PUTO BIGAS"}, {"type": "product", "code": "", "category": "PUTO", "product": "PUTO SMALL"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "KING'S BOTTLED WATER"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "CALAMANSI JUICE (Island)"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "COKE in can"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "GATORADE 500ML"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "HERBAL TEA TAMARIND"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "NATURAL SOYA"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "NESTEA"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "NESTLE CHUCKIE"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "PEPSI"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "SELECTA MOO"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "SIP PURIFIED WATER 1000ml"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "SMART C+"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "VITAMILK"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "ZAMBO CALAMANSI JUICE"}, {"type": "product", "code": "", "category": "BEVERAGE", "product": "ZESTO BIG"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "code": "", "category": "MISC", "product": "EMPANADA BOX"}, {"type": "product", "code": "", "category": "MISC", "product": "EMPANADA CONTAINER"}, {"type": "product", "code": "", "category": "MISC", "product": "FOUNTAIN CANDLE"}, {"type": "product", "code": "", "category": "MISC", "product": "GOLD NUMBER CANDLE"}, {"type": "product", "code": "", "category": "MISC", "product": "MILK TEA CUPS 16 oz"}, {"type": "product", "code": "", "category": "MISC", "product": "MILK TEA CUPS 22 oz"}, {"type": "product", "code": "", "category": "MISC", "product": "PREMIUM CAKE TOPPER60"}, {"type": "product", "code": "", "category": "MISC", "product": "SPIRAL CANDLE /PC"}, {"type": "product", "code": "200366", "category": "MISC", "product": "STANDARD CAKETOPPER40"}, {"type": "product", "code": "200367", "category": "MISC", "product": "TEA EGG CONTAINER"}];
const directMap = {
  "cheesy mamon": "CHEESY mamon /pc",
  "garlic bread toast": "Garlic bread",
  "chocolate caramel round": "CHOCOLATE CARAMEL AFFORDABLE",
  "spanish latte large": "MILK TEA CUPS 22 oz",
  "kings purified water": "KING'S BOTTLED WATER",
  "assorted candy": "ASSTD CANDY/ CHOCOLATES",
  "mango supreme round": "MANGO SUPREME AFFORDABLE",
  "baked chicken empanada x 3": "Baked chicken empanada",
  "ivory bloom round": "Ivory Bloom 6\"",
  "mochalicious round": "MOCHALICIOUS AFFORDABLE",
  "hopia mongo / ube combi x20": "Hopia Mongo",
  "spanish latte medium": "MILK TEA CUPS 16 oz",
  "free almond jelly cups": "ALMOND JELLY",
  "ham & cheese roll": "HAM AND CHEESE ROLL",
  "flossy chiffon": "Flossy chiffon x4",
  "almond jelly cup": "ALMOND JELLY",
  "dolce de leche rnd": "DOLCE DE LECHE AFFORDABLE",
  "banana loaf": "Banana loaf (New Improved)",
  "mocha latte large": "MILK TEA CUPS 22 oz",
  "iced coffee jelly 22oz": "MILK TEA CUPS 22 oz",
  "smore's fudge": "S'mores fudge x8",
  "taro lava medium": "MILK TEA CUPS 16 oz",
  "strawberry matcha large": "MILK TEA CUPS 22 oz",
  "lemonade duo": "MILK TEA CUPS 22 oz",
  "paborito breads": "Paborito Breads x10",
  "mini party cakes": "Mini cakes x12",
  "mocha drip round": "MILK TEA CUPS 16 oz",
  "mocha latte medium": "MILK TEA CUPS 16 oz",
  "add on coffee jelly": "MILK TEA CUPS 22 oz",
  "caramel macchiato large": "CHOCO MOCHA DUET",
  "the duet (choco mocha)": "NUTELLA CAKE AFFORDABLE",
  "nutella affordable": "MILK TEA CUPS 16 oz",
  "strawberry matcha medium": "CHEESY FLOSSY BAR",
  "flossy cheese bar": "Kitkat Mousse Cake AFFORDABLE",
  "kitkat mousse affordable": "FLAVORED GARLIC PEANUT",
  "flavored peanut": "CHOCO DREAM AFFORDABLE",
  "choco dream round": "MILK TEA CUPS 16 oz",
  "caramel macchiato medium": "MILK TEA CUPS 22 oz",
  "fresh honey lemon": "GUMMY CANDY ASSTD. POUCH",
  "gummy candy": "DINOSAUR EGG BIG",
  "dinosaur big": "Choco Fantasy AFFORDABLE",
  "choco fantasy round": "MILK TEA CUPS 16 oz",
  "milk tea duo medium": "MILK TEA CUPS 22 oz",
  "original matcha large": "MILK TEA CUPS 22 oz",
  "ube yum round": "Ube Halaya AFFORDABLE",
  "choco fantasy rectangle": "Choco Fantasy AFFORDABLE",
  "okinawa large": "MILK TEA CUPS 16 oz",
  "iced coffee jelly 16oz": "MILK TEA CUPS 22 oz",
  "lemon cucumber": "MILK TEA CUPS 22 oz",
  "lemon iced tea": "MILK TEA CUPS 16 oz",
  "salted caramel medium": "MILK TEA CUPS 22 oz",
  "salted caramel large": "MILK TEA CUPS 16 oz",
  "strawberry latte medium": "MILK TEA CUPS 16 oz",
  "original matcha medium": "MILK TEA CUPS 16 oz",
  "wintermelon medium": "MILK TEA CUPS 16 oz",
  "dirty matcha large": "MILK TEA CUPS 22 oz",
  "taro lava large": "MILK TEA CUPS 22 oz",
  "signature choco large": "MILK TEA CUPS 22 oz",
  "cucumber lemonade": "MILK TEA CUPS 22 oz",
  "dirty matcha medium": "MILK TEA CUPS 16 oz",
  "lemon kalamansi": "MILK TEA CUPS 22 oz",
  "fresh honey lemonade": "MILK TEA CUPS 22 oz",
  "coffee roti bun": "Coffee roti roll"
};
const excludedItems = new Set(["add on coffee jelly", "box of pianono"]);

const norm = s => (s || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');

function levenshtein(a, b) {
  a = norm(a); b = norm(b);
  const m = a.length, n = b.length;
  if (m === 0) return n; if (n === 0) return m;
  const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0] = i;
  for (let j=0;j<=n;j++) dp[0][j] = j;
  for (let i=1;i<=m;i++) {
    for (let j=1;j<=n;j++) {
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[m][n];
}
function similarity(a,b) {
  const L = Math.max(norm(a).length, norm(b).length) || 1;
  return 1 - (levenshtein(a,b)/L);
}
  // 🔹 Special handling for Baked Chicken Empanada x3, x8, x10
function empanadaSpecialCase(productName, qty) {
  if (!productName) return { name: productName, qty };

  // Normalize input: lowercase + trim + collapse spaces
  let cleanName = productName.toLowerCase().replace(/\s+/g, ' ').trim();

  // Regex: match "baked chicken empanada xN" where N = 3, 8, or 10
  let match = cleanName.match(/^baked chicken empanada x\s*(3|8|10)$/i);

  if (match) {
    let multiplier = parseInt(match[1], 10);
    return {
      name: "Baked Chicken Empanada",   // ✅ Normalized name
      qty: qty * multiplier             // ✅ Multiply only Qty
    };
  }

  // If not matched → return unchanged
  return { name: productName, qty };
}

let outputRows = [];
let fuzzyRows = [];
let excludedRows = [];
let unmatchedRows = [];
let matchCount = 0;

function rebuildTable() {
  const tbody = document.querySelector('#outTable tbody');
  tbody.innerHTML = '';
  outputRows.forEach(row => {
    if (!row) return;
    if (row.type==='separator') {
      const tr=document.createElement('tr'); tr.className='sep';
      const td=document.createElement('td'); td.colSpan=5; td.innerHTML='&nbsp;';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    const tr=document.createElement('tr');
    ['code','category','product','sales'].forEach(k=>{
      const td=document.createElement('td'); td.textContent=row[k]||'';
      tr.appendChild(td);
    });
    const td=document.createElement('td'); td.textContent=''; tr.appendChild(td);
    tbody.appendChild(tr);
  });
  if (fuzzyRows.length || excludedRows.length || unmatchedRows.length) {
    const trSep=document.createElement('tr'); trSep.className='sep';
    const tdSep=document.createElement('td'); tdSep.colSpan=5; tdSep.innerHTML='&nbsp;';
    trSep.appendChild(tdSep); tbody.appendChild(trSep);
    fuzzyRows.concat(excludedRows, unmatchedRows).forEach(row=>{
      const tr=document.createElement('tr');
      ['code','category','product','sales'].forEach(k=>{
        const td=document.createElement('td'); td.textContent=row[k]||'';
        tr.appendChild(td);
      });
      const td=document.createElement('td'); td.textContent=row.qty||''; tr.appendChild(td);
      tbody.appendChild(tr);
    });
  }
  document.getElementById('matchCount').textContent=matchCount;
  document.getElementById('fuzzyCount').textContent=fuzzyRows.length;
  document.getElementById('excludedCount').textContent=excludedRows.length;
  document.getElementById('unmatchedCount').textContent=unmatchedRows.length;
  document.getElementById('downloadBtn').disabled=(outputRows.length===0);
  document.getElementById('copyBtn').disabled=(outputRows.length===0);
}

function mapName(rawName) {
  const n = norm(rawName);
  if (directMap[n]) return directMap[n];
  const nm = norm(rawName);
  if (excludedItems.has(nm)) return function processCsvRows(csvRows) {
  if (!csvRows.length) return;
  const dsirProducts = DSIR.filter(r=>r.type==='product');
  document.getElementById('dsirCount').textContent = dsirProducts.length;
  outputRows = DSIR.map(r=> (r.type==='separator') ? {type:'separator'} : {...r, sales:0} );
  fuzzyRows=[]; excludedRows=[]; unmatchedRows=[]; matchCount=0;

  const items=[];
  csvRows.forEach(row=>{
    const rawName = row['Item'] ?? row['item'] ?? '';

    // 🔹 Apply Empanada special case
    let adjQty = Math.abs(parseFloat((row['Adjustment']??row['adjustment']??'0').toString().replace(/[, ]+/g,''))||0);
    let { name, qty } = empanadaSpecialCase(rawName, adjQty);

    const mapped = mapName(name);

    let adj = parseFloat((row['Adjustment']??row['adjustment']??'0').toString().replace(/[, ]+/g,'')) || 0;
    let sales = (adj < 0) ? Math.abs(adj) : 0;

    if(mapped === null) {
      excludedRows.push({code:'',category:'',product:rawName,sales:0,qty:qty});
      return;
    }
    items.push({raw:rawName,mapped:mapped,sales,qty:qty});
  });

  const dsirNormNames=dsirProducts.map(p=>norm(p.product));

  // Exact match
  items.forEach(it=>{
    const nm=norm(it.mapped);
    const idx=dsirNormNames.indexOf(nm);
    if(idx>=0) {
      const target=outputRows.filter(r=>r.type!=='separator')[idx];
      target.sales=(target.sales||0)+it.sales;
      matchCount++;
      it.matched=true;
    }
  });

  // Fuzzy aggregated
  const fuzzyAgg=new Map();
  items.filter(it=>!it.matched).forEach(it=>{
    const nm=norm(it.mapped);
    let bestIdx=-1,bestSim=0;
    for(let i=0;i<dsirNormNames.length;i++) {
      const sim=similarity(nm,dsirNormNames[i]);
      if(sim>bestSim){bestSim=sim;bestIdx=i;}
    }
    if(bestSim>=0.85&&bestIdx>=0) {
      const target=outputRows.filter(r=>r.type!=='separator')[bestIdx];
      target.sales=(target.sales||0)+it.sales;
      const key=bestIdx;
      const prev=fuzzyAgg.get(key)||0;
      fuzzyAgg.set(key,prev+it.sales);
      it.matched=true;
    }
  });
  fuzzyAgg.forEach((sales,idx)=>{
    const p=dsirProducts[idx];
    fuzzyRows.push({code:p.code||'',category:p.category||'',product:p.product,sales,qty:''});
  });

  // Unmatched aggregated
  const unmatchedAgg=new Map();
  items.filter(it=>!it.matched).forEach(it=>{
    const key=norm(it.raw);
    const prev=unmatchedAgg.get(key)||0;
    unmatchedAgg.set(key,prev+it.qty);
  });
  unmatchedAgg.forEach((qty,name)=>{
    unmatchedRows.push({code:'',category:'',product:name,sales:0,qty});
  });

  rebuildTable();
  }
    null;
  if (directMap[nm]) return directMap[nm];
  if (nm.endsWith('medium')) return 'MILK TEA CUPS 16 oz';
  if (nm.endsWith('large') || nm.includes('22oz')) return 'MILK TEA CUPS 22 oz';
  return rawName;
}



document.getElementById('processBtn').addEventListener('click',()=>{
  const file=document.getElementById('csvFile').files[0];
  if(!file) return alert('Choose CSV');
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>processCsvRows(res.data)});
});

document.getElementById('downloadBtn').addEventListener('click',()=>{
  const rows=[['Code','Category','Product','Sales','Qty']];
  outputRows.forEach(r=>{
    if(r.type==='separator') rows.push(['','','','','']);
    else rows.push([r.code||'',r.category||'',r.product||'',r.sales||0,'']);
  });
  if(fuzzyRows.length||excludedRows.length||unmatchedRows.length) rows.push(['','','','','']);
  fuzzyRows.concat(excludedRows,unmatchedRows).forEach(r=>rows.push([r.code||'',r.category||'',r.product||'',r.sales||0,r.qty||'']));
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'DSIR Output');
  XLSX.writeFile(wb,'DSIR-Processed.xlsx');
});

document.getElementById('copyBtn').addEventListener('click',()=>{
  const values=[];
  outputRows.forEach(r=>{
    if(r.type==='separator') values.push('');
    else values.push(r.sales||0);
  });
  const text=values.join('\n');

  const textarea=document.createElement('textarea');
  textarea.value=text;
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    alert('Sales column copied!');
  } catch(e) {
    alert('Copy failed');
  }
  document.body.removeChild(textarea);
});
</script>
<script>
// v6.0 patch: embed NEW_DSIR (Sheet1) and add Upload/Restore handlers without changing existing logic.
// Keep V5 behavior intact; only layer upload/restore and ACTIVE_DSIR syncing.

(function(){
  try{
    // Preserve old embedded if present
    window.OLD_DSIR = window.EMBEDDED_DSIR ? JSON.parse(JSON.stringify(window.EMBEDDED_DSIR)) : (window.OLD_DSIR || []);

    // Inject new embedded DSIR (from uploaded latest Excel sheet 1)
window.NEW_EMBEDDED_DSIR = [{"type": "product", "product": "Asado roll", "sales": 0}, {"type": "product", "product": "Asado square", "sales": 0}, {"type": "product", "product": "CHEESE BREAD x6", "sales": 0}, {"type": "product", "product": "Baked chicken empanada", "sales": 0}, {"type": "product", "product": "Braided ham", "sales": 0}, {"type": "product", "product": "Brown sugar raisin", "sales": 0}, {"type": "product", "product": "Cheese bites", "sales": 0}, {"type": "product", "product": "Double Cheese Bread x4", "sales": 0}, {"type": "product", "product": "Cheese roll", "sales": 0}, {"type": "product", "product": "Coffee bavarian bun", "sales": 0}, {"type": "product", "product": "Coffee roti roll", "sales": 0}, {"type": "product", "product": "Cream Bread", "sales": 0}, {"type": "product", "product": "Creamy enzaimada", "sales": 0}, {"type": "product", "product": "Custard cream bun", "sales": 0}, {"type": "product", "product": "Enzaimada bites", "sales": 0}, {"type": "product", "product": "Enzaimada rolls", "sales": 0}, {"type": "product", "product": "Flossy meat roll", "sales": 0}, {"type": "product", "product": "Four Seasons", "sales": 0}, {"type": "product", "product": "Garlic bread", "sales": 0}, {"type": "product", "product": "HAM & QUESO", "sales": 0}, {"type": "product", "product": "Ham salad bread", "sales": 0}, {"type": "product", "product": "Hongkong milk bread", "sales": 0}, {"type": "product", "product": "Hotdog with cheese", "sales": 0}, {"type": "product", "product": "Malunggay cheese pandesal", "sales": 0}, {"type": "product", "product": "Malunggay tuna", "sales": 0}, {"type": "product", "product": "Milky baby pandesal", "sales": 0}, {"type": "product", "product": "Milky ube roll", "sales": 0}, {"type": "product", "product": "Premium Cheese Bread", "sales": 0}, {"type": "product", "product": "Mongo loaf", "sales": 0}, {"type": "product", "product": "Mongo roll", "sales": 0}, {"type": "product", "product": "Coco cluster x6", "sales": 0}, {"type": "product", "product": "Pandecoco", "sales": 0}, {"type": "product", "product": "Pineapple delight", "sales": 0}, {"type": "product", "product": "SET1 BM5 (m.w.f)", "sales": 0}, {"type": "product", "product": "SET2 CE5", "sales": 0}, {"type": "product", "product": "SET 3 CE2,BMP3(m.w.f)", "sales": 0}, {"type": "product", "product": "SET 4 FS1,CRR2,MR2", "sales": 0}, {"type": "product", "product": "SET5 BS2,MR1,US2", "sales": 0}, {"type": "product", "product": "Hopia Mongo", "sales": 0}, {"type": "product", "product": "Hopia Ube", "sales": 0}, {"type": "product", "product": "Hopia Container", "sales": 0}, {"type": "product", "product": "Mochi Bread x6", "sales": 0}, {"type": "product", "product": "Special mongo bun", "sales": 0}, {"type": "product", "product": "Special pandesal x9", "sales": 0}, {"type": "product", "product": "Ube enzaimada single", "sales": 0}, {"type": "product", "product": "Ube macapuno loaf", "sales": 0}, {"type": "product", "product": "Ube munchies", "sales": 0}, {"type": "product", "product": "Ube queso pandesal", "sales": 0}, {"type": "product", "product": "Ube stick", "sales": 0}, {"type": "product", "product": "Wheat bread", "sales": 0}, {"type": "product", "product": "Cheese stick bread", "sales": 0}, {"type": "product", "product": "Pizzadog", "sales": 0}, {"type": "product", "product": "Volcanic Cheese Melt", "sales": 0}, {"type": "product", "product": "Pizza round", "sales": 0}, {"type": "product", "product": "BABY ENZAIMADA", "sales": 0}, {"type": "product", "product": "Spicy Chicken Floss", "sales": 0}, {"type": "product", "product": "RAISIN & WALNUT SOUR DOUGH", "sales": 0}, {"type": "product", "product": "Malunggay Pandesal x9", "sales": 0}, {"type": "product", "product": "Premium Cheese Roll", "sales": 0}, {"type": "product", "product": "DULCE de UBE", "sales": 0}, {"type": "product", "product": "CHEESY FLOSSY BAR", "sales": 0}, {"type": "product", "product": "UBE MOCHI BREAD", "sales": 0}, {"type": "product", "product": "MONGO MOCHI BREAD", "sales": 0}, {"type": "product", "product": "DOUBLE MUNCHIES", "sales": 0}, {"type": "product", "product": "BAVARIAN MUNCHIES", "sales": 0}, {"type": "product", "product": "PINEAPPLE MUNCHIES", "sales": 0}, {"type": "product", "product": "RAISIN MINIS", "sales": 0}, {"type": "product", "product": "CINNAMON ROLLS", "sales": 0}, {"type": "product", "product": "Malunggay Cheese Mini", "sales": 0}, {"type": "product", "product": "Paborito Breads x10", "sales": 0}, {"type": "product", "product": "Craving Breads x 6", "sales": 0}, {"type": "product", "product": "HAM AND CHEESE ROLL", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "product": "Banana loaf (New Improved)", "sales": 0}, {"type": "product", "product": "Banana slice", "sales": 0}, {"type": "product", "product": "CHEESY mamon /pc", "sales": 0}, {"type": "product", "product": "Cheese pie", "sales": 0}, {"type": "product", "product": "Chiffon cake", "sales": 0}, {"type": "product", "product": "Choco crinkles", "sales": 0}, {"type": "product", "product": "Choco vanilla", "sales": 0}, {"type": "product", "product": "Flossy chiffon x4", "sales": 0}, {"type": "product", "product": "Fluffy chiffon", "sales": 0}, {"type": "product", "product": "Fudge brownies x12", "sales": 0}, {"type": "product", "product": "Milky egg pie", "sales": 0}, {"type": "product", "product": "Mini cakes x12", "sales": 0}, {"type": "product", "product": "Mocha vanilla", "sales": 0}, {"type": "product", "product": "S'mores fudge x8", "sales": 0}, {"type": "product", "product": "Sossy flossy roll", "sales": 0}, {"type": "product", "product": "Yema Krema", "sales": 0}, {"type": "product", "product": "Egg Pie Whole", "sales": 0}, {"type": "product", "product": "Fudge brownies Single", "sales": 0}, {"type": "product", "product": "Macaroons", "sales": 0}, {"type": "product", "product": "FLUFFY CHIFFON BIG", "sales": 0}, {"type": "product", "product": "LECHE FLAN CAKE", "sales": 0}, {"type": "product", "product": "Mini Jelly Roll", "sales": 0}, {"type": "product", "product": "PREMIUM TAISAN BAR", "sales": 0}, {"type": "product", "product": "FLUFFY CHIFFON SMALL", "sales": 0}, {"type": "product", "product": "Choco Fantasy 6\"", "sales": 0}, {"type": "product", "product": "Choco Fantasy AFFORDABLE", "sales": 0}, {"type": "product", "product": "Choco Fantasy 8X12\"", "sales": 0}, {"type": "product", "product": "CHOCOLATE CARAMEL AFFORDABLE", "sales": 0}, {"type": "product", "product": "CHOCOLATE CARAMEL 8\"", "sales": 0}, {"type": "product", "product": "CHOCOLATE CARAMEL 8X12\"", "sales": 0}, {"type": "product", "product": "DOLCE DE LECHE AFFORDABLE", "sales": 0}, {"type": "product", "product": "DOLCE DE LECHE 8\"", "sales": 0}, {"type": "product", "product": "DOLCE DE LECHE 8X16\"", "sales": 0}, {"type": "product", "product": "Ivory Bloom 6\"", "sales": 0}, {"type": "product", "product": "Ivory Bloom 8\"", "sales": 0}, {"type": "product", "product": "Ivory Bloom 8X12\"", "sales": 0}, {"type": "product", "product": "Kitkat Mousse Cake AFFORDABLE", "sales": 0}, {"type": "product", "product": "Kitkat Mousse Cake 8\"", "sales": 0}, {"type": "product", "product": "MANGO SUPREME AFFORDABLE", "sales": 0}, {"type": "product", "product": "MANGO SUPREME 8\"", "sales": 0}, {"type": "product", "product": "MOCHA DRIP AFFORDABLE", "sales": 0}, {"type": "product", "product": "MOCHA DRIP 8\"", "sales": 0}, {"type": "product", "product": "MOCHALICIOUS AFFORDABLE", "sales": 0}, {"type": "product", "product": "MOCHALICIOUS 8\"", "sales": 0}, {"type": "product", "product": "MOCHALICIOUS 8X12\"", "sales": 0}, {"type": "product", "product": "NUTELLA CAKE AFFORDABLE", "sales": 0}, {"type": "product", "product": "NUTELLA CAKE 8\"", "sales": 0}, {"type": "product", "product": "CHOCO DREAM AFFORDABLE", "sales": 0}, {"type": "product", "product": "Oreo Dream 8\"", "sales": 0}, {"type": "product", "product": "SALTED CARAMEL 6\"", "sales": 0}, {"type": "product", "product": "SALTED CARAMEL 8\"", "sales": 0}, {"type": "product", "product": "Strawberry Shortcake AFFORDABLE", "sales": 0}, {"type": "product", "product": "Strawberry Shortcake 8\"", "sales": 0}, {"type": "product", "product": "Ube Halaya AFFORDABLE", "sales": 0}, {"type": "product", "product": "Ube Yum 8\"", "sales": 0}, {"type": "product", "product": "UBE LECHE FLAN AFFORDABLE", "sales": 0}, {"type": "product", "product": "UBE LECHE FLAN 8\"", "sales": 0}, {"type": "product", "product": "Ube Yum 8x12", "sales": 0}, {"type": "product", "product": "Yema CAKE AFFORDABLE", "sales": 0}, {"type": "product", "product": "Yema Streussel 8\"", "sales": 0}, {"type": "product", "product": "CHOCO MOCHA DUET", "sales": 0}, {"type": "separator"}, {"type": "product", "product": "ADOBO PEANUT POUCH", "sales": 0}, {"type": "product", "product": "ALMOND JELLY", "sales": 0}, {"type": "product", "product": "ASSTD CANDY/ CHOCOLATES", "sales": 0}, {"type": "product", "product": "ASSTD CHIPS (7 SEAS)", "sales": 0}, {"type": "product", "product": "ASSTD LOLLIPOP", "sales": 0}, {"type": "product", "product": "ASSTD MUSHROOM CHIPS", "sales": 0}, {"type": "product", "product": "ASSTD POLVORON X12", "sales": 0}, {"type": "product", "product": "ATSARA", "sales": 0}, {"type": "product", "product": "BANANA CHIPS BIG", "sales": 0}, {"type": "product", "product": "BARQUILLOS", "sales": 0}, {"type": "product", "product": "BARQUILLOS TUB", "sales": 0}, {"type": "product", "product": "BIG OVEN BROWNIES", "sales": 0}, {"type": "product", "product": "CANDY CANE PER PACK", "sales": 0}, {"type": "product", "product": "CARP SARAP", "sales": 0}, {"type": "product", "product": "CHARACTER SURPRISE", "sales": 0}, {"type": "product", "product": "CHICHA CORN", "sales": 0}, {"type": "product", "product": "CHICHA POP", "sales": 0}, {"type": "product", "product": "CHICHA POP CON.", "sales": 0}, {"type": "product", "product": "CHOCO BISCUIT (ORIGO)", "sales": 0}, {"type": "product", "product": "CHOCO BISCUIT STICK", "sales": 0}, {"type": "product", "product": "CHOCO NIPS", "sales": 0}, {"type": "product", "product": "CHUNKY PEANUT BUTTER", "sales": 0}, {"type": "product", "product": "CLASSIC Biscocho", "sales": 0}, {"type": "product", "product": "CREAMY APAS", "sales": 0}, {"type": "product", "product": "DABOY BITE SIZE", "sales": 0}, {"type": "product", "product": "DABOY CHICHARON", "sales": 0}, {"type": "product", "product": "DABOY TRAY BACKFAT", "sales": 0}, {"type": "product", "product": "DAILY NUT", "sales": 0}, {"type": "product", "product": "DAILYPLUS ASST.", "sales": 0}, {"type": "product", "product": "DARK/RED VELVET CRINKLES", "sales": 0}, {"type": "product", "product": "DILIS CRISPY / SPICY", "sales": 0}, {"type": "product", "product": "DILIS MIXED", "sales": 0}, {"type": "product", "product": "DINOSAUR EGG BIG", "sales": 0}, {"type": "product", "product": "DINOSAUR EGG SMALL", "sales": 0}, {"type": "product", "product": "DRIED FRUIT", "sales": 0}, {"type": "product", "product": "EGG COINS", "sales": 0}, {"type": "product", "product": "EGG CRACKERS", "sales": 0}, {"type": "product", "product": "ESPASOL", "sales": 0}, {"type": "product", "product": "EVERYDAY MIX NUTS", "sales": 0}, {"type": "product", "product": "FISH CRACKER SMALL", "sales": 0}, {"type": "product", "product": "FLAVORED GARLIC PEANUT", "sales": 0}, {"type": "product", "product": "GARLIC PEANUT POUCH", "sales": 0}, {"type": "product", "product": "GOLD COINS POUCH", "sales": 0}, {"type": "product", "product": "GUMMY CANDY ASSTD. POUCH", "sales": 0}, {"type": "product", "product": "HAMBURGER SQUISHY", "sales": 0}, {"type": "product", "product": "HOPIA KING", "sales": 0}, {"type": "product", "product": "JELLY BEANS", "sales": 0}, {"type": "product", "product": "JUMBO EGG", "sales": 0}, {"type": "product", "product": "JUMBO WHIRL LOLLIPOP", "sales": 0}, {"type": "product", "product": "Kiamoy Pouch", "sales": 0}, {"type": "product", "product": "KIKIAM", "sales": 0}, {"type": "product", "product": "KROPECK SHRIMP", "sales": 0}, {"type": "product", "product": "LECHE FLAN", "sales": 0}, {"type": "product", "product": "LENGUA", "sales": 0}, {"type": "product", "product": "MACARONI CRACKERS", "sales": 0}, {"type": "product", "product": "MIXED NUTS POUCH", "sales": 0}, {"type": "product", "product": "MUNCH ASSRTED", "sales": 0}, {"type": "product", "product": "NACHOS ASSRTED", "sales": 0}, {"type": "product", "product": "OCEAN SERIES", "sales": 0}, {"type": "product", "product": "OGOY", "sales": 0}, {"type": "product", "product": "OGOY STICK", "sales": 0}, {"type": "product", "product": "OTAP", "sales": 0}, {"type": "product", "product": "OTAP NEW", "sales": 0}, {"type": "product", "product": "PABORITA SMALL", "sales": 0}, {"type": "product", "product": "PACENCIA WHITE", "sales": 0}, {"type": "product", "product": "party lollipop", "sales": 0}, {"type": "product", "product": "PEANUT BAR", "sales": 0}, {"type": "product", "product": "PEANUT NOUGAT", "sales": 0}, {"type": "product", "product": "PEANUT POUCH", "sales": 0}, {"type": "product", "product": "PILIPIT BIG X10", "sales": 0}, {"type": "product", "product": "POTATO CHIPS", "sales": 0}, {"type": "product", "product": "RAINBOW MALLOWS", "sales": 0}, {"type": "product", "product": "RED VELVET BROWNIE", "sales": 0}, {"type": "product", "product": "ROASTED CASHEW", "sales": 0}, {"type": "product", "product": "SECO VARIETY", "sales": 0}, {"type": "product", "product": "SHRIMP CRACKERS", "sales": 0}, {"type": "product", "product": "SIOPAO SQUISHY", "sales": 0}, {"type": "product", "product": "SMALL MANTOU", "sales": 0}, {"type": "product", "product": "SPECIAL BISCOCHO", "sales": 0}, {"type": "product", "product": "SPECIAL MONGO BEAN", "sales": 0}, {"type": "product", "product": "SPECIAL PABORITA", "sales": 0}, {"type": "product", "product": "SQUASH SEEDS", "sales": 0}, {"type": "product", "product": "SWEET TAMARIND CANDY", "sales": 0}, {"type": "product", "product": "TAMARIND CANDY", "sales": 0}, {"type": "product", "product": "TEA EGG", "sales": 0}, {"type": "product", "product": "TIKOY HOPIA", "sales": 0}, {"type": "product", "product": "TOAST GARLIC /LESS SUGAR", "sales": 0}, {"type": "product", "product": "TOASTED MAMON", "sales": 0}, {"type": "product", "product": "TOFU ASSORTED FLV.", "sales": 0}, {"type": "product", "product": "TORONES POUCH", "sales": 0}, {"type": "product", "product": "TORONES TUB", "sales": 0}, {"type": "product", "product": "URARO", "sales": 0}, {"type": "product", "product": "YEMA MINI PACK", "sales": 0}, {"type": "product", "product": "YEMA TOWER", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "product": "3n1 KAKANIN", "sales": 0}, {"type": "product", "product": "ESPASOL", "sales": 0}, {"type": "product", "product": "KUTSINTA", "sales": 0}, {"type": "product", "product": "PUTO PAO", "sales": 0}, {"type": "product", "product": "SUMAN PINIPIG SMALL", "sales": 0}, {"type": "separator"}, {"type": "product", "product": "PUTO BIG", "sales": 0}, {"type": "product", "product": "PUTO BIGAS", "sales": 0}, {"type": "product", "product": "PUTO SMALL", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "product": "KING'S BOTTLED WATER", "sales": 0}, {"type": "product", "product": "CALAMANSI JUICE (Island)", "sales": 0}, {"type": "product", "product": "COKE in can", "sales": 0}, {"type": "product", "product": "GATORADE 500ML", "sales": 0}, {"type": "product", "product": "HERBAL TEA TAMARIND", "sales": 0}, {"type": "product", "product": "NATURAL SOYA", "sales": 0}, {"type": "product", "product": "NESTEA", "sales": 0}, {"type": "product", "product": "NESTLE CHUCKIE", "sales": 0}, {"type": "product", "product": "PEPSI", "sales": 0}, {"type": "product", "product": "SELECTA MOO", "sales": 0}, {"type": "product", "product": "SIP PURIFIED WATER 1000ml", "sales": 0}, {"type": "product", "product": "SMART C+", "sales": 0}, {"type": "product", "product": "VITAMILK", "sales": 0}, {"type": "product", "product": "ZAMBO CALAMANSI JUICE", "sales": 0}, {"type": "product", "product": "ZESTO BIG", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "product": "EMPANADA BOX", "sales": 0}, {"type": "product", "product": "EMPANADA CONTAINER", "sales": 0}, {"type": "product", "product": "FOUNTAIN CANDLE", "sales": 0}, {"type": "product", "product": "GOLD NUMBER CANDLE", "sales": 0}, {"type": "product", "product": "MILK TEA CUPS 16 oz", "sales": 0}, {"type": "product", "product": "MILK TEA CUPS 22 oz", "sales": 0}, {"type": "product", "product": "PREMIUM CAKE TOPPER60", "sales": 0}, {"type": "product", "product": "SPIRAL CANDLE /PC", "sales": 0}, {"type": "product", "product": "STANDARD CAKETOPPER40", "sales": 0}, {"type": "product", "product": "TEA EGG CONTAINER", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "product", "product": "FOOD PANDA", "sales": 0}, {"type": "product", "product": "GRAB FOOD", "sales": 0}, {"type": "separator"}, {"type": "product", "product": "PARTY CAKES", "sales": 0}, {"type": "separator"}, {"type": "product", "product": "1 DAY BEFORE", "sales": 0}, {"type": "product", "product": "yema cake", "sales": 0}, {"type": "product", "product": "butter cup", "sales": 0}, {"type": "product", "product": "egg pie", "sales": 0}, {"type": "product", "product": "ube egg pie", "sales": 0}, {"type": "product", "product": "ube cheese pandesal", "sales": 0}, {"type": "product", "product": "hotdog buns", "sales": 0}, {"type": "product", "product": "crinkles", "sales": 0}, {"type": "product", "product": "vanilla 8x11", "sales": 0}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}, {"type": "separator"}];

    // Use the new embedded as the default EMBEDDED_DSIR
    window.EMBEDDED_DSIR = (Array.isArray(window.NEW_EMBEDDED_DSIR) ? window.NEW_EMBEDDED_DSIR : []).map(function(r){ if(r.type==='product') return {type:'product', product:r.product||'', sales:0}; return {type:'separator'}; });

    // Initialize ACTIVE_DSIR and aliases if not already set by app
    function initActive(){
      window.ACTIVE_DSIR = window.ACTIVE_DSIR && Array.isArray(window.ACTIVE_DSIR) && window.ACTIVE_DSIR.length ? window.ACTIVE_DSIR.slice() : window.EMBEDDED_DSIR.map(function(r){ return (r.type==='separator')?{type:'separator'}:{type:'product', product:r.product||'', sales:0}; } );
      window.DEFAULT_DSIR = window.DEFAULT_DSIR || window.ACTIVE_DSIR.slice();
      window.all = window.ACTIVE_DSIR;
      var lbl = document.getElementById('activeDsirLabel');
      if(lbl) lbl.textContent = 'Active DSIR: Embedded (Sheet 1)';
      if(typeof addLog==='function') addLog('✅ Embedded DSIR loaded (Sheet 1: '+window.ACTIVE_DSIR.length+' rows)');
    }

    document.addEventListener('DOMContentLoaded', function(){
      initActive();

      // ensure hidden dsir file input
      var existing = document.getElementById('dsirFile');
      if(!existing){
        var inp = document.createElement('input');
        inp.type='file'; inp.id='dsirFile'; inp.accept='.xlsx,.xls,.csv'; inp.style.display='none';
        document.body.appendChild(inp);
        inp.addEventListener('change', function(ev){
          var file = ev.target.files && ev.target.files[0];
          if(!file) return;
          var reader = new FileReader();
          reader.onload = function(e){ 
            try{
              var data = new Uint8Array(e.target.result);
              var wb = XLSX.read(data,{type:'array'});
              var sheets = wb.SheetNames.slice();
              var chooseAndLoad = function(sheetName){
                var ws = wb.Sheets[sheetName];
                // header at row 3 -> range:2
                var rows = XLSX.utils.sheet_to_json(ws,{defval:'', raw:true, range:2});
                var newActive = [];
                for(var i=0;i<rows.length;i++){
                  var row = rows[i];
                  // find product field by common keys
                  var p='';
                  for(var k in row){
                    if(/product|description|item|name|desc/i.test(k) && String(row[k]).trim()){ p = String(row[k]).trim(); break; }
                  }
                  if(!p){
                    newActive.push({type:'separator'});
                  } else {
                    newActive.push({type:'product', product: p, sales:0});
                  }
                }
                if(newActive.length===0){ if(typeof addLog==='function') addLog('❌ Error: Uploaded DSIR had no data'); if(typeof showToast==='function') showToast('❌ Uploaded DSIR had no data'); return; }
                window.ACTIVE_DSIR = newActive;
                window.all = window.ACTIVE_DSIR;
                var lbl = document.getElementById('activeDsirLabel'); if(lbl) lbl.textContent = 'Active DSIR: Uploaded ('+sheetName+')';
                if(typeof addLog==='function') addLog('✅ DSIR loaded (uploaded: '+file.name+', sheet: '+sheetName+', rows: '+newActive.length+')');
                if(typeof showToast==='function') showToast('✅ DSIR loaded: '+newActive.length+' rows');
                if(typeof rebuildTable==='function') rebuildTable(window.ACTIVE_DSIR);
              };

              if(sheets.length>1){
                if(typeof showSheetSelector==='function'){ showSheetSelector(sheets, function(choice){ if(choice==='All Sheets'){ // merge all
                      var merged=[];
                      for(var si=0;si<sheets.length;si++){ 
                        var ws2 = wb.Sheets[sheets[si]];
                        var rows2 = XLSX.utils.sheet_to_json(ws2,{defval:'', raw:true, range:2});
                        for(var j=0;j<rows2.length;j++){
                          var row=rows2[j]; var p=''; for(var k in row){ if(/product|description|item|name|desc/i.test(k) && String(row[k]).trim()){ p=String(row[k]).trim(); break; } }
                          if(!p) merged.push({type:'separator'}); else merged.push({type:'product', product:p, sales:0});
                        }
                      }
                      window.ACTIVE_DSIR = merged; window.all = window.ACTIVE_DSIR; if(typeof rebuildTable==='function') rebuildTable(window.ACTIVE_DSIR);
                    } else { chooseAndLoad(choice); } } ); 
                } else { chooseAndLoad(sheets[0]); }
              } else { chooseAndLoad(sheets[0]); }
            }catch(err){
              if(typeof addLog==='function') addLog('❌ Error parsing uploaded DSIR: '+err);
              if(typeof showToast==='function') showToast('❌ Error parsing uploaded DSIR');
            }
          };
          reader.readAsArrayBuffer(file);
        });
      } // end ensure input

      // hook sidebar buttons if present
      var uploadBtn = document.getElementById('mUploadDsir');
      if(uploadBtn){ uploadBtn.addEventListener('click', function(){ var e=document.getElementById('dsirFile'); if(e) e.click(); }); }

      var restoreBtn = document.getElementById('mRestore');
      if(restoreBtn){ restoreBtn.addEventListener('click', function(){ 
        try{ 
          window.ACTIVE_DSIR = window.EMBEDDED_DSIR.map(function(r){ return (r && r.type==='separator')?{type:'separator'}:{type:'product', product:r.product||'', sales:0}; }); 
          window.all = window.ACTIVE_DSIR;
          var lbl = document.getElementById('activeDsirLabel'); if(lbl) lbl.textContent = 'Active DSIR: Embedded (Sheet 1)';
          if(typeof rebuildTable==='function') rebuildTable(window.ACTIVE_DSIR);
          if(typeof addLog==='function') addLog('✅ DSIR restored to embedded (Sheet 1)');
          if(typeof showToast==='function') showToast('✅ DSIR restored to embedded (Sheet 1)');
        }catch(err){ if(typeof addLog==='function') addLog('❌ Restore failed: '+err); if(typeof showToast==='function') showToast('❌ Restore failed'); }
      }); }

    }); // DOMContentLoaded
  }catch(e){ console.error(e); if(typeof addLog==='function') addLog('❌ v6 patch failed: '+e); }
})();
</script>
<div id="sideOverlay"></div><aside id="sidebar"><header>DSIR Harvester — Menu</header><div class="sub">by Lemuel Ponciano</div><div class="menu"><button class="btn" id="mUploadDsir" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14M12 6v.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>Upload DSIR<small>Replace active DSIR (xlsx/xls/csv)</small></div></button><button class="btn" id="mRestore" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M3 12h18M12 3v18" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>Restore Embedded<small>Back to embedded DSIR (Sheet 1)</small></div></button><button class="btn" id="mUploadSales" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>Upload Sales CSV<small>Choose sales CSV to process</small></div></button><button class="btn" id="mDownloadExcel" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M7 17l5-5 5 5M7 7h10" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>Download Excel<small>Save processed DSIR workbook</small></div></button><button class="btn" id="mLogs" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>Channel Logs<small>Open log modal</small></div></button><button class="btn" id="mAbout" type="button"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M12 8h.01M11 12h2v4h-2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg><div>About<small>Version, notes</small></div></button></div><div id="activeDsirWrap"><div>Active DSIR: <span id="activeDsirLabel">Embedded (Sheet 1)</span></div></div></aside><div class="modal" id="logsModal"><div class="panel"><h3>Channel Logs</h3><div id="logsBody" style="max-height:60vh; overflow-y:auto; font-family:monospace; font-size:13px; border:1px solid #eee; padding:6px; background:#fafafa; margin:6px 0;"></div><div class="foot"><button id="logsDownload" type="button">Download Logs</button><button id="logsClear" type="button">Clear Logs</button><button id="logsClose" type="button">Close</button></div></div></div><div class="modal" id="aboutModal"><div class="panel"><h3>About DSIR Harvester v6.1 (Core)</h3><p>Built on your stable V5. Embedded DSIR (Sept 2025, Sheet 1). Old DSIR preserved in code. Upload/Restore DSIR + Sales processing.</p><div class="foot"><button id="aboutClose" type="button">Close</button></div></div></div><script>
// v6.1 sidebar core wiring (non-destructive)
(function(){
  function qs(id){ return document.getElementById(id); }
  var sidebar = qs('sidebar');
  var overlay = qs('sideOverlay');
  var toggle  = qs('menuToggle');

  function openMenu(){ if(sidebar){ sidebar.classList.add('open'); } if(overlay){ overlay.classList.add('open'); } }
  function closeMenu(){ if(sidebar){ sidebar.classList.remove('open'); } if(overlay){ overlay.classList.remove('open'); } }

  if(toggle){ toggle.addEventListener('click', openMenu); }
  if(overlay){ overlay.addEventListener('click', closeMenu); }
  document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeMenu(); });

  // Buttons → call existing logic
  var upDsir = qs('mUploadDsir');
  if(upDsir){ upDsir.addEventListener('click', function(){ var f=qs('dsirFile'); if(f){ f.click(); } closeMenu(); }); }

  var restore = qs('mRestore');
  if(restore){ restore.addEventListener('click', function(){ restore.click(); }); } // keep existing handler via id hook

  var upSales = qs('mUploadSales');
  if(upSales){ upSales.addEventListener('click', function(){ var f=qs('csvFile'); if(f){ f.click(); } closeMenu(); }); }

  var dl = qs('mDownloadExcel');
  if(dl){ dl.addEventListener('click', function(){ var b=qs('downloadBtn'); if(b){ b.click(); } closeMenu(); }); }

  var logsBtn = qs('mLogs'), logsModal = qs('logsModal'), logsClose = qs('logsClose');
  if(logsBtn && logsModal){ logsBtn.addEventListener('click', function(){ logsModal.classList.add('open'); closeMenu(); }); }
  if(logsClose){ logsClose.addEventListener('click', function(){ logsModal.classList.remove('open'); }); }

  var aboutBtn = qs('mAbout'), aboutModal = qs('aboutModal'), aboutClose = qs('aboutClose');
  if(aboutBtn && aboutModal){ aboutBtn.addEventListener('click', function(){ aboutModal.classList.add('open'); closeMenu(); }); }
  if(aboutClose){ aboutClose.addEventListener('click', function(){ aboutModal.classList.remove('open'); }); }
})();
</script>
<script>
// v6.2 Channel Logs System (persistent)
(function(){
  window.channelLogs = JSON.parse(localStorage.getItem('channelLogs')||'[]');

  window.addLog = function(msg){
    try{
      var ts = new Date().toLocaleString();
      var entry = `[${ts}] ${msg}`;
      window.channelLogs.unshift(entry); // newest first
      localStorage.setItem('channelLogs', JSON.stringify(window.channelLogs));
    }catch(e){ console.error('log fail', e); }
  };

  function renderLogs(){
    var body = document.getElementById('logsBody');
    if(!body) return;
    body.innerHTML = '';
    if(!window.channelLogs.length){
      body.innerHTML = '<em>No logs yet.</em>';
      return;
    }
    window.channelLogs.forEach(function(line){
      var div = document.createElement('div');
      div.style.borderBottom = '1px solid #eee';
      div.style.padding = '2px 0';
      // colorize simple
      if(line.includes('❌')) div.style.color = 'red';
      else if(line.includes('✅')) div.style.color = 'green';
      div.textContent = line;
      body.appendChild(div);
    });
  }

  var logsBtn = document.getElementById('mLogs');
  var logsModal = document.getElementById('logsModal');
  var logsClose = document.getElementById('logsClose');
  var logsDownload = document.getElementById('logsDownload');
  var logsClear = document.getElementById('logsClear');

  if(logsBtn && logsModal){
    logsBtn.addEventListener('click', function(){
      renderLogs();
      logsModal.classList.add('open');
      var lb = document.getElementById('logsBody'); if(lb) lb.scrollTop = 0;
    });
  }
  if(logsClose){ logsClose.addEventListener('click', function(){ logsModal.classList.remove('open'); }); }

  if(logsDownload){
    logsDownload.addEventListener('click', function(){
      var content = (window.channelLogs||[]).join("\n");
      var now = new Date();
      function pad(n){ return n<10?'0'+n:n; }
      var fname = 'DSIRLogs_'+now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+'_'+pad(now.getHours())+'-'+pad(now.getMinutes())+'-'+pad(now.getSeconds())+'.txt';
      var blob = new Blob([content], {type:'text/plain'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href=url; a.download=fname;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      addLog('Logs downloaded as '+fname);
    });
  }

  if(logsClear){
    logsClear.addEventListener('click', function(){
      if(confirm('Clear all logs?')){
        window.channelLogs=[];
        localStorage.removeItem('channelLogs');
        renderLogs();
        addLog('Logs cleared');
      }
    });
  }

  // Initial log on page load
  document.addEventListener('DOMContentLoaded', function(){
    addLog('✅ Embedded DSIR loaded (Sheet 1: '+(window.EMBEDDED_DSIR?window.EMBEDDED_DSIR.length:0)+' rows)');
  });

  // Hook into Process button if exists
  var proc = document.getElementById('processBtn') || document.getElementById('process');
  if(proc){
    proc.addEventListener('click', function(){
      setTimeout(function(){
        if(typeof window.matchCount!=='undefined'){
          addLog('Processed CSV → Exact:'+document.getElementById('matchCount').textContent+
            ', Fuzzy:'+document.getElementById('fuzzyCount').textContent+
            ', Unmatched:'+document.getElementById('unmatchedCount').textContent);
        }
      }, 600);
    });
  }

  // Hook into download button
  var dlBtn = document.getElementById('downloadBtn');
  if(dlBtn){
    dlBtn.addEventListener('click', function(){ addLog('✅ Excel exported'); });
  }

  // Hook into copy button
  var copyBtn = document.getElementById('copyBtn');
  if(copyBtn){
    copyBtn.addEventListener('click', function(){ addLog('✅ Sales copied to clipboard'); });
  }

})();</script>

<script>
(function(){
  function addLog(msg){
    if (window.addLog) { window.addLog(msg); }
    else { console.log(msg); }
  }

  function normalizeToYMD(val) {
    if (!val) return null;
    // try Date()
    const d = new Date(val);
    if (!isNaN(d.getTime())) {
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    // yyyy-mm-dd or yyyy/mm/dd
    let m = String(val).match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
    if (m) {
      const y = m[1], mo=String(m[2]).padStart(2,'0'), da=String(m[3]).padStart(2,'0');
      return `${y}-${mo}-${da}`;
    }
    // mm/dd/yyyy
    m = String(val).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (m) {
      let y = m[3]; if (y.length===2){ y = (+y<70?'20'+y:'19'+y); }
      const mo=String(m[1]).padStart(2,'0'), da=String(m[2]).padStart(2,'0');
      return `${y}-${mo}-${da}`;
    }
    // fallback: take first token
    const first = String(val).split(/\s+/)[0];
    const d2 = new Date(first);
    if (!isNaN(d2.getTime())) {
      const y=d2.getFullYear(), mo=String(d2.getMonth()+1).padStart(2,'0'), da=String(d2.getDate()).padStart(2,'0');
      return `${y}-${mo}-${da}`;
    }
    return null;
  }

  function findDateField(row){
    // try common variants
    const keys = Object.keys(row);
    const prefs = ['Date','date','DATE','Transaction Date','Sales Date','Sales_Date','Txn Date','Created Time'];
    for (const k of prefs){ if (k in row) return k; }
    // heuristic: first key containing 'date'
    const hit = keys.find(k => /date/i.test(k));
    return hit || keys[0];
  }

  function ensurePapa(cb){
    if (window.Papa && window.Papa.parse) return cb();
    const s = document.createElement('script');
    s.src = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js";
    s.onload = cb;
    document.head.appendChild(s);
  }

  function buildDateDropdown(file, dateFilterEl){
    ensurePapa(() => {
      window.Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const data = res.data || [];
          if (!data.length) return;
          const field = findDateField(data[0]);
          const dates = [];
          for (const r of data){
            const ymd = normalizeToYMD(r[field]);
            if (ymd) dates.push(ymd);
          }
          const unique = Array.from(new Set(dates));
          // sort newest -> oldest
          unique.sort((a,b)=> new Date(b) - new Date(a));
          // populate with placeholder first
          dateFilterEl.innerHTML = "";
          const ph = document.createElement('option');
          ph.value = ""; ph.disabled = true; ph.selected = true;
          ph.textContent = "— Select date —";
          dateFilterEl.appendChild(ph);
          unique.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            dateFilterEl.appendChild(opt);
          });
          addLog(`[Info] Detected dates: ${unique.join(', ')}`);
        }
      });
    });
  }

  function filterAndProcess(file, chosenDate){
    ensurePapa(() => {
      window.Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const data = res.data || [];
          if (!data.length) return alert('CSV appears empty');
          const field = findDateField(data[0]);
          const filtered = data.filter(r => normalizeToYMD(r[field]) === chosenDate);
          if (!filtered.length){
            alert('No rows for the selected date: '+chosenDate);
            return;
          }
          addLog(`[Info] Processing for date: ${chosenDate} (rows: ${filtered.length})`);
          if (typeof window.processCsvRows === 'function'){
            window.processCsvRows(filtered);
          } else {
            // fallback: try a custom event others may listen to
            const ev = new CustomEvent('csv:filtered', {detail:{rows:filtered, date:chosenDate}});
            window.dispatchEvent(ev);
          }
        }
      });
    });
  }

  const csvInput = document.getElementById('csvFile');
  const dateFilter = document.getElementById('dateFilter');
  const processBtn = document.getElementById('processBtn');
  if (!csvInput || !dateFilter || !processBtn) return;

  // Build date list on CSV selection
  csvInput.addEventListener('change', () => {
    const f = csvInput.files && csvInput.files[0];
    if (!f) return;
    buildDateDropdown(f, dateFilter);
  });

  // Intercept Process click to enforce date filter (one date only)
  processBtn.addEventListener('click', function(e){
    e.preventDefault();
    e.stopImmediatePropagation();
    const file = csvInput.files && csvInput.files[0];
    if (!file){ alert('Choose CSV first'); return; }
    const chosen = dateFilter.value;
    if (!chosen){ alert('Choose a date in the dropdown'); return; }
    filterAndProcess(file, chosen);
  }, true);
})();
</script>
</body>
</html>
