<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receipt Generator ‚Äî King's Bakeshop (v14 Sidebar+Fix)</title>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

  :root{
    --bg:#f5f5f5; --text:#333; --accent:#FF7E00; --accent-2:#FF4500;
    --card:#fff; --card-alt:#f9f9f9; --muted:#666; --border:#ddd;
    --summary-bg:#FF7E00; --summary-text:#fff; --btn-disabled:#aaa;
  }
  body.dark{
    --bg:#121212; --text:#eaeaea; --accent:#FF8A3D; --accent-2:#FF5C33;
    --card:#1e1e1e; --card-alt:#232323; --muted:#bdbdbd; --border:#333;
    --summary-bg:#FF5C33; --summary-text:#fff; --btn-disabled:#555;
  }
  *{box-sizing:border-box;}
  body{
    font-family: 'Poppins', sans-serif;
    background: var(--bg); color: var(--text);
    margin:0; padding:0;
    transition: background-color 0.6s ease, color 0.6s ease;
  }

  /* ===== Header ===== */
  header{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 16px;
    position:sticky; top:0;
    background:rgba(255,255,255,0.6);
    backdrop-filter:blur(12px);
    border-bottom:1px solid var(--border);
    z-index:200;
  }
  body.dark header{ background:rgba(18,18,18,0.6); }
  .title-wrap h1{ margin:0; font-size:20px; color:var(--accent-2); }
  .title-wrap h2{ margin:0; font-size:12px; color:var(--muted); }

  /* Transparent menu icon */
  .icon-btn{
    background:none; border:none; color:var(--text);
    font-size:22px; cursor:pointer; padding:6px; border-radius:8px;
  }
  .icon-btn:hover{ color:var(--accent); background:transparent; }

  .theme-icon{ font-size:20px; cursor:pointer; transition:transform 0.6s ease; display:inline-block; }
  .theme-icon.spin{ transform:rotate(360deg) scale(1.2); }

  .container{ max-width:980px; margin:auto; padding:20px; }

  label{ display:block; margin-top:15px; font-weight:600; }
  input{
    margin-top:6px; padding:10px; width:100%;
    border-radius:8px; border:2px solid var(--accent);
    background:var(--card); color:var(--text);
  }
  button{
    margin-top:10px; padding:12px; border:none; border-radius:25px;
    font-weight:600; background:var(--accent); color:#fff; cursor:pointer;
    transition:all 0.25s ease;
  }
  button:hover:enabled{ background:var(--accent-2); }
  button:disabled{ background:var(--btn-disabled); cursor:not-allowed; }
  .btn-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

  .receipt-card {
  display:block !important;
  width:100% !important;
  margin:10px 0 !important;
}
.row-line { display:block !important; }
.receipt-table { display:none !important; }
  .receipt-card.alt{ background:var(--card-alt); }
  .receipt-header{ font-weight:600; margin-bottom:8px; }
  .rounding{ border:2px solid var(--accent); }
  .rounding .receipt-header{ color:var(--accent); }

  .summary-card{
    background:var(--summary-bg); color:var(--summary-text);
    font-weight:600; border-radius:10px;
    padding:14px; margin-top:20px; text-align:center;
  }
  .footer{ margin-top:14px; text-align:center; }

  /* ===== Sidebar Menu ===== */
  .sidebar{
    position:fixed; top:0; left:0;
    width:300px; height:100%;
    background:rgba(255,255,255,0.7);
    backdrop-filter:blur(12px);
    border-right:1px solid var(--border);
    transform:translateX(-100%);
    transition:transform 0.3s ease;
    z-index:1000;
    display:flex; flex-direction:column;
  }
  body.dark .sidebar{ background:rgba(18,18,18,0.7); }
  .sidebar.open{ transform:translateX(0); }
  .sidebar-header{ display:flex; justify-content:space-between; align-items:center; padding:12px; }
  .sidebar-content{ flex:1; overflow-y:auto; padding:12px; }
  .sidebar h3{ margin:0; color:var(--accent-2); }
  .menu-card{ padding:12px; margin:6px 0; border-radius:8px; cursor:pointer; }
  .menu-card:hover{ background:var(--accent); color:#fff; }

  /* ===== Modals ===== */
  .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); backdrop-filter:blur(6px);
    justify-content:center; align-items:center; z-index:1200; }
  .modal-content{
    background:var(--card); color:var(--text);
    padding:20px; border-radius:12px;
    max-width:560px; max-height:85vh; overflow:auto;
    border:1px solid var(--border);
  }
  .modal-content h3{ margin-top:0; color:var(--accent-2); }
  .price-row{ display:flex; justify-content:space-between; align-items:center; margin:6px 0; }
  .price-row input{ width:90px; text-align:right; padding:6px; border-radius:6px; border:1px solid var(--border); }
  .section-title{ margin-top:12px; font-weight:600; color:var(--accent-2); }
  .close-btn{ margin-top:12px; padding:8px 14px; border:none; border-radius:20px; background:var(--accent); color:#fff; cursor:pointer; }
  .close-btn:hover{ background:var(--accent-2); }

  
/* ===== Responsive Receipt Layout ===== */
.row-line { display:block; }
.receipt-table { display:none; width:100%; border-collapse:collapse; margin-top:6px; }
.receipt-table th,.receipt-table td { padding:6px 8px; text-align:left; border-bottom:1px solid var(--border); }
.receipt-table th { background:rgba(0,0,0,0.05); font-weight:bold; }
body.dark .receipt-table th { background:rgba(255,255,255,0.06); }
.gross-row td { font-weight:bold; color:var(--accent-2); }
@media (min-width:768px) and (orientation:landscape), (min-width:992px){
  .row-line { display:none; }
  .receipt-table { display:table; }
}

@media print{
    header,.btn-row,.footer,label,input,.modal,.sidebar{ display:none!important; }
    .container{ max-width:100%; padding:0; }
    .receipt-card,.summary-card{ box-shadow:none; border:1px solid #000; page-break-inside:avoid; }
  }
  </style>
</head>
<body>
  <header>
    <button id="menuBtn" class="icon-btn" title="Menu">‚ò∞</button>
    <div class="title-wrap">
      <h1>Receipt Generator ‚Äî King's Bakeshop</h1>
      <h2>by Lemuel Ponciano</h2>
    </div>
    <div class="theme-switch"><span id="themeIcon" class="theme-icon">üåô</span></div>
  </header>

  <!-- Sidebar Menu -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button class="icon-btn" onclick="closeMenu()" title="Close">‚úñ</button>
    </div>
    <div class="sidebar-content">
      <div class="menu-card" onclick="openHelp()">‚ùì Help</div>
      <div class="menu-card" onclick="openVersion()">‚ÑπÔ∏è Version Info</div>
      <div class="menu-card" onclick="reportIssue()">üì• Report Project Summary</div>
      <div class="menu-card" onclick="openPriceAdjust()">üõ† Price Adjustment</div>
    </div>
  </div>

  <div class="container">
    <label>Starting Receipt #</label>
    <input id="startNumber" type="number" placeholder="e.g., 3087" />
    <label>Gross Target (‚Ç±)</label>
    <input id="grossTarget" type="number" step="0.01" placeholder="e.g., 21460.40" />
    <label>Approx. Receipt Count</label>
    <input id="approxCount" type="number" placeholder="e.g., 55" />

    <div class="btn-row">
      <button id="genBtn">Generate Receipts</button>
      <button id="copyBtn">Copy All Receipts</button>
      <button id="printBtn">üñ®Ô∏è Print / Save PDF</button>
    </div>

    <div id="receipts"></div>

    <div class="footer"><button id="reportBtn" disabled>üì• Report Project Summary</button></div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <h3>Rounding Receipt (Pangsuma)</h3>
      <p>Last receipt must be <b>breads-only</b> ‚Ç±150‚Äì‚Ç±250. Centavos from Target Gross go here.</p>
      <button class="close-btn" onclick="closeHelp()">OK</button>
    </div>
  </div>

  <!-- Version Modal -->
  <div id="versionModal" class="modal">
    <div class="modal-content">
      <h3>Version 14 Sidebar + Fix</h3>
      <ul style="text-align:left;font-size:14px;">
        <li>Modern sidebar menu</li>
        <li>Price Adjustment modal restored with full products</li>
        <li>Transparent menu icon</li>
        <li>Fixed generator (cakes solo, rounding 150‚Äì250)</li>
      </ul>
      <button class="close-btn" onclick="closeVersion()">OK</button>
    </div>
  </div>

  <!-- Price Adjustment Modal -->
  <div id="priceModal" class="modal">
    <div class="modal-content">
      <h3>Price Adjustment</h3>
      <input id="searchBox" type="text" placeholder="Search product..." style="width:100%;padding:8px;margin:10px 0;border-radius:8px;border:2px solid var(--accent);"/>
      <div id="priceList"></div>
      <button onclick="savePrices()">‚úÖ Save Changes</button>
      <button onclick="resetPrices()">üîÑ Reset Defaults</button>
      <button class="close-btn" onclick="closePriceAdjust()">Close</button>
    </div>
  </div>

<script>
// ===== Full Default Product Lists =====
const DEFAULT_BREADS = {
"3-Meat Buns": 99, "Asado Roll": 55, "Asado Square": 188, "Baby Enzaimada": 49, 
"Baked Chicken Empanada": 65, "BAKED CHICKEN EMPANADA x10": 630, "BAKED CHICKEN EMPANADA x3": 192, 
"BAKED CHICKEN EMPANADA x8": 510, "Bavarian Munchies": 55, "Blueberry Cinnamon Single": 65, 
"Braided Ham": 47, "Butter Toast": 48, "Brown Sugar Raisin": 125, "Cheese Bites x10": 75, 
"Cream Bread": 80, "Creamy Enzaimada": 37, "Custard Cream Bun": 38, "Double Cheese Bread x4": 75, 
"Double Muncheese": 55, "Dulce De Ube": 108, "Enzaimada Bites": 88, "Enzaimada Rolls": 155, 
"Flossy Cheese Bar": 108, "Flossy Meat Roll (Chicken)": 55, "Four Seasons": 38, 
"Garlic Butter Toast": 69, "Ham & Cheese Roll": 59, "Ham & Queso": 47, "Hongkong Milk Bread": 65, 
"Hopia Mongo/Ube x20": 168, "Hotdog With Cheese": 47, "Lotus Biscoff Cinnamon Single": 65, 
"Malunggay Chiz Pandesal X9": 69, "Malunggay Pandesal x9": 69, "Malunggay Tuna": 46, 
"Milky Baby Pandesal": 75, "Milky Ube Roll x6": 70, "Mochi Bread x6": 128, "Mongo Loaf": 65, 
"Nutella Cinnamon Single": 65, "Pandecoco": 18, "Pineapple Delight": 32, "Pineapple Munchies": 55, 
"Pistacchio Cinnamon Single": 65, "Pizza Round": 52, "Pizzadog": 59, "Premium Cheese Rolls": 168, 
"Raisin & Walnut Sourdough": 69, "Raisin Minis": 55, "S'Mores Cinnamon Single": 65, 
"Snow Cream": 58, "Special Mongo Bun": 62, "Special Pandesal x9": 62, "Spicy Chicken Floss": 59, 
"Strawberry Cinnamon Single": 65, "Ube Enzaimada Single": 47, "Ube Macapuno Loaf": 77, 
"Ube Marble Loaf": 140, "Ube Munchies x10": 85, "Ube Queso Pandesal x6": 125, 
"Volcanic Cheese Melt": 172, "Wheat Bread": 75, "White Chocolate Almond": 59, 
"Soft Sourdough (Plain)": 35, "Soft Sourdough (Sesame)": 35, "Cheese Roll": 37, 
"Cheese Stick Bread": 45, "Cinnamon Roll": 55, "Coco Cluster x6": 65, "Coffee Bavarian Bun": 52, 
"Coffee Roti Roll": 35, "Banana Loaf (New Improved)": 188, "Banana Slice": 45, "Cheese Pie": 29, 
"Chiffon cake": 68, "Choco Crinkles": 58, "Choco Vanilla Sandwich": 42, "Cotton Cloud": 142, 
"Flossy Chiffon x4": 110, "Fudge Brownies Single": 29, "Fudge Brownies x12": 128, 
"Leche Flan Cake": 195, "Macaroons x11": 98, "Milky Egg Pie Slice": 49, "Milky Egg Pie Whole": 375, 
"Mini Jelly Roll x12": 220, "Mini Jelly Roll x8": 110, "Mini Party Cakes x12": 230, 
"Mocha Vanilla Sandwich": 42, "Premium Taisan Bar": 85, "S'mores Fudge x8": 198, 
"Sossy Flossy Roll": 110, "Very Cheesy Mamon": 49, "Yema Krema": 90, "SET 1 BM5": 119, 
"SET 2 CE5": 139, "SET 3 CE2, BMP3": 129, "SET 4 MR2, US2, FS1": 119, "SET 5 MR2, BS1, CRR2": 129, 
"SET 6 PAD2, BM1, PCO2": 119, "SET 7 CCR2, BM1, PCO2": 119, "Box of Pianono x20": 290, 
"Cheese Bites x24": 260, "Double Cheese Roll x8": 190, "Enzaimada Trio x6": 260, 
"Enzaimada Trio x9": 398, "Milky Cream Cheese Roll x8": 260, "Mini Cream Cheese Enzaimada": 290, 
"Paborito Box x10": 190, "Savory Buns x6": 210, "Savory Buns x9": 295, "Signature Enzaimada x6": 225, 
"Signature Enzaimada x9": 330, "Soft Cinnamon Rolls x6": 290, "Spanish Coffee Bun x9": 175
};

const DEFAULT_CAKES = {
"Choco Fudge Bar": 285, "Mocha Caramel Bar": 285, "Ivory Blossom": 495, 
"Mocha Vanilla Bliss": 495, "Choco Fantasy": 550, "Choco Fudge": 550, 
"Yema Delight": 550, "Choco Caramel": 575, "Dulce de Leche": 575, 
"Mochalicious": 575, "Ube Halaya": 575, "Choco Dream": 595, 
"Mango Supreme": 595, "Salted Caramel Walnut": 595, "The Duet": 595, 
"Ube Leche Flan": 595, "Berry Black Forest": 695, "Kitkat Mousse": 695, 
"Nutella": 695, "Choco Fantasy Rectangle": 795, "Dulce de Leche Rectangle": 795, 
"Mochalicious Rectangle": 795, "The Flavor Parade": 985
};


let breads = {}, cakes = {};
function loadPrices(){
  breads = JSON.parse(localStorage.getItem("breads") || JSON.stringify(DEFAULT_BREADS));
  cakes  = JSON.parse(localStorage.getItem("cakes")  || JSON.stringify(DEFAULT_CAKES));
}
function renderPriceAdjust(filter=""){
  const list=document.getElementById("priceList");
  const f = filter.toLowerCase();
  let html = "<div class='section-title'>ü•ñ Breads</div>";
  Object.entries(breads).forEach(([name, price])=>{
    if(!f || name.toLowerCase().includes(f)){
      html += `<div class="price-row"><span>${name}</span>
                <input type="number" class="price-input" data-cat="bread" data-name="${name}" value="${price}" /></div>`;
    }
  });
  html += "<div class='section-title'>üç∞ Cakes</div>";
  Object.entries(cakes).forEach(([name, price])=>{
    if(!f || name.toLowerCase().includes(f)){
      html += `<div class="price-row"><span>${name}</span>
                <input type="number" class="price-input" data-cat="cake" data-name="${name}" value="${price}" /></div>`;
    }
  });
  list.innerHTML = html;
}
function savePrices(){
  document.querySelectorAll(".price-input").forEach(inp=>{
    const val = +inp.value, cat = inp.dataset.cat, name = inp.dataset.name;
    if(cat==="bread") breads[name]=val; else cakes[name]=val;
  });
  localStorage.setItem("breads", JSON.stringify(breads));
  localStorage.setItem("cakes",  JSON.stringify(cakes));
  alert("‚úÖ Prices updated!");
}
function resetPrices(){
  breads = {...DEFAULT_BREADS};
  cakes  = {...DEFAULT_CAKES};
  localStorage.removeItem("breads"); localStorage.removeItem("cakes");
  renderPriceAdjust();
}


// ===== v4 Data Bridge =====
// Build BREADS/CAKES arrays from current editable price objects (breads/cakes)
function rebuildArraysFromStorage(){
  BREADS = Object.entries(breads).map(([n,p])=>[n, Number(p)]);
  CAKES  = Object.entries(cakes).map(([n,p])=>[n, Number(p)]);
}

// ===== Helpers =====
const $ = s => document.querySelector(s);
function money(n){ return "‚Ç±"+(+n).toFixed(2); }
function vatFromGross(g){ return +(g*12/112).toFixed(2); }
function netFromGross(g){ return +(g - vatFromGross(g)).toFixed(2); }

let projectSummary = "";

// ===== Theme =====
function applyTheme(){
  const theme = localStorage.getItem("theme") || "light";
  document.body.classList.toggle("dark", theme==="dark");
  document.body.classList.toggle("light", theme==="light");
  const icon = $("#themeIcon"); if(icon) icon.textContent = theme==="dark" ? "‚òÄÔ∏è" : "üåô";
}
function toggleTheme(){
  const dark = !document.body.classList.contains("dark");
  localStorage.setItem("theme", dark ? "dark" : "light");
  applyTheme();
  const icon = $("#themeIcon"); if(icon){ icon.classList.add("spin"); setTimeout(()=>icon.classList.remove("spin"), 600); }
}
document.addEventListener("DOMContentLoaded", ()=>{
  applyTheme();
  $("#themeIcon").addEventListener("click", toggleTheme);
});

// ===== Sidebar =====
function openMenu(){ $("#sidebar").classList.add("open"); }
function closeMenu(){ $("#sidebar").classList.remove("open"); }

// ===== Modals =====
function openHelp(){ $("#helpModal").style.display="flex"; }
function closeHelp(){ $("#helpModal").style.display="none"; }
function openVersion(){ $("#versionModal").style.display="flex"; }
function closeVersion(){ $("#versionModal").style.display="none"; }
function openPriceAdjust(){ loadPrices(); renderPriceAdjust(); $("#priceModal").style.display="flex"; }
function closePriceAdjust(){ $("#priceModal").style.display="none"; }

// ===== Generator (safe fallback) =====






function generate(){
  loadPrices();
  const start  = +$("#startNumber").value;
  const target = +(parseFloat($("#grossTarget").value).toFixed(2));
  const count  = +$("#approxCount").value;
  if(!start || !target || !count){ alert("Fill in all inputs"); return; }
  if(target < 50){ alert("Target gross too low."); return; }

  const breadsArr = Object.entries(breads);
  const cakesArr  = Object.entries(cakes);

  // Cake rule: disable cakes entirely when requested receipts <= 20
  const cakesEnabled = count > 20;

  const bigTicket = new Set([
    "Egg Pie Whole","Banana loaf (New Improved)","Premium Cheese Bread",
    "Hopia Mongo","Hopia Ube","Paborito Breads x10","Craving Breads x 6"
  ]);

  const LOW_PRICES = Array.from(new Set(breadsArr.map(x=>x[1]))).sort((a,b)=>a-b);
  const HIGH_PRICES = LOW_PRICES.slice().reverse();

  function addItem(arr, qty, name, price){
    let found = arr.find(it => it[1]===name && it[2]===price);
    if(found){
      found[0]+=qty;
    } else {
      if(arr.length < 5){
        arr.push([qty,name,price]);
      } else {
        let pick = arr[Math.floor(Math.random()*arr.length)];
        pick[0]+=qty;
      }
    }
  }

  function getQty(name){
    if(bigTicket.has(name)) return 1 + Math.floor(Math.random()*2); // 1-2
    return 1 + Math.floor(Math.random()*5); // 1-5
  }

  function makeBreadReceipt(){
    let k = 1 + Math.floor(Math.random()*5);
    let pool=[...breadsArr]; pool.sort(()=>Math.random()-0.5);
    let items=[];
    for(let i=0;i<pool.length && items.length<k;i++){
      let [n,p]=pool[i];
      let qty = getQty(n);
      addItem(items, qty, n, p);
    }
    return {items};
  }

  function makeCakeReceipt(){
    let [n,p]=cakesArr[Math.floor(Math.random()*cakesArr.length)];
    return {items:[[1,n,p]],cake:true};
  }

  // --- 1) Generate exactly (count-1) normal receipts ---
  let receipts=[], current=start;
  for(let i=0;i<Math.max(0,count-1);i++){
    let cand;
    if(cakesEnabled && Math.random()<0.18){
      cand = makeCakeReceipt();
    } else {
      cand = makeBreadReceipt();
    }
    if(cand.items && cand.items.length>0){
      cand.gross = cand.items.reduce((s,it)=>s+(it[0]*it[2]),0);
      cand.num = current++;
      receipts.push(cand);
    }
  }

  // If we somehow generated fewer (shouldn't happen), pad with tiny receipt lines before balancing
  while(receipts.length < count-1){
    receipts.push({num:current++, items:[[1,"Pandecoco",18]], gross:18});
  }
  // If too many, trim down to count-1
  if(receipts.length > count-1){
    receipts = receipts.slice(0, count-1);
    current = receipts[receipts.length-1].num + 1;
  }

  function recomputeRunning(){
    return +(receipts.reduce((S,r)=> S + r.items.reduce((s,it)=>s+(it[0]*it[2]),0), 0).toFixed(2));
  }
  let running = recomputeRunning();

  // --- 2) Exact peso balancing across receipts (centavos reserved for rounding) ---
  function tryAddPeso(p){
    // add one item of price p to a random non-cake receipt
    for(let tries=0; tries<60; tries++){
      let r = receipts[Math.floor(Math.random()*receipts.length)];
      if(!r || r.cake) continue;
      let candidates = breadsArr.filter(bp => bp[1]===p);
      if(candidates.length===0) return false;
      let [name,price] = candidates[Math.floor(Math.random()*candidates.length)];
      addItem(r.items, 1, name, price);
      r.gross = r.items.reduce((s,it)=>s+(it[0]*it[2]),0);
      return true;
    }
    return false;
  }

  function tryRemovePesoPreferHigh(p){
    // remove one unit of an item priced p from any receipt (prefer high prices loop outside)
    for(let r of receipts){
      if(r.cake) continue;
      for(let it of r.items){
        if(it[2]===p && it[0]>0){
          it[0]-=1;
          if(it[0]===0){
            r.items = r.items.filter(x=>x!==it);
          }
          r.gross = r.items.reduce((s,a)=>s+(a[0]*a[2]),0);
          return true;
        }
      }
    }
    return false;
  }

  function balancePesos(){
    // Work only with integer pesos; leave centavos for the final rounding receipt
    let diff = +(target - running).toFixed(2);
    let pesosNeeded = Math.trunc(diff); // integer part toward zero
    // If diff negative (overshoot), pesosNeeded is negative

    let safety=0;
    while(pesosNeeded !== 0 && safety < 5000){
      if(pesosNeeded > 0){
        // Need to add
        let p = LOW_PRICES.find(v => v <= pesosNeeded) || LOW_PRICES[0];
        if(!tryAddPeso(p)){
          // two-sum add fallback
          let done=false;
          for(let a of LOW_PRICES){
            for(let b of LOW_PRICES){
              if(a+b===pesosNeeded){
                if(tryAddPeso(a) && tryAddPeso(b)){ done=true; break; }
              }
            }
            if(done) break;
          }
          if(!done){
            // random small add to make progress
            let rp = LOW_PRICES[Math.floor(Math.random()*LOW_PRICES.length)];
            tryAddPeso(rp);
          }
        }
      } else {
        // Need to remove (overshoot)
        let need = -pesosNeeded;
        // Prefer removing a higher price first to converge faster
        let pHigh = HIGH_PRICES.find(v => v <= need) || HIGH_PRICES[HIGH_PRICES.length-1];
        if(!tryRemovePesoPreferHigh(pHigh)){
          // try two-sum removal
          let done=false;
          for(let a of HIGH_PRICES){
            for(let b of HIGH_PRICES){
              if(a+b===need){
                if(tryRemovePesoPreferHigh(a) && tryRemovePesoPreferHigh(b)){ done=true; break; }
              }
            }
            if(done) break;
          }
          if(!done){
            // Swap strategy: add 'a' and remove 'b' where (b-a) = need
            let found=false;
            for(let b of HIGH_PRICES){
              for(let a of LOW_PRICES){
                if(b-a===need){
                  if(tryAddPeso(a) && tryRemovePesoPreferHigh(b)){ found=true; break; }
                }
              }
              if(found) break;
            }
            if(!found){
              // last resort: remove any high price to move towards zero
              for(let b of HIGH_PRICES){
                if(tryRemovePesoPreferHigh(b)){ break; }
              }
            }
          }
        }
      }
      running = recomputeRunning();
      diff = +(target - running).toFixed(2);
      pesosNeeded = Math.trunc(diff);
      safety++;
    }
    // Return remaining centavos (positive or negative). We'll correct via rounding receipt.
    return +(target - running).toFixed(2);
  }

  let remaining = balancePesos();

  // Centavos-only rounding value
  let centavos = +((+remaining).toFixed(2));
  // If centavos is negative (tiny overshoot), convert by removing 1 peso and adding positive centavos
  if(centavos < 0){
    // Remove 1 peso via high-price removal if possible
    for(let b of HIGH_PRICES){
      if(tryRemovePesoPreferHigh(b)){ break; }
    }
    running = recomputeRunning();
    centavos = +(target - running).toFixed(2);
  }

  // Safety clamp
  if(centavos < 0) centavos = 0;
  centavos = +centavos.toFixed(2);

  // --- 3) Final receipt: rounding (centavos only) ---
  let finalNum = current;
  const roundingReceipt = {num:finalNum, items:[[1,"Rounding Breads", centavos]], gross:centavos, rounding:true};
  receipts.push(roundingReceipt);

  // Ensure exact count (pad before rounding if needed, though we took care earlier)
  if(receipts.length > count){
    // remove extra non-rounding receipts from before rounding
    let over = receipts.length - count;
    receipts.splice(count-1, over); // keep rounding as last
  } else if(receipts.length < count){
    // pad with tiny receipts of 18 before rounding, then re-adjust rounding
    let need = count - receipts.length;
    let addGross=0;
    for(let i=0;i<need;i++){
      receipts.splice(receipts.length-1,0,{num:finalNum++, items:[[1,"Pandecoco",18]], gross:18});
      addGross+=18;
    }
    running = recomputeRunning();
    centavos = +(target - running).toFixed(2);
    if(centavos < 0) centavos = 0;
    receipts[receipts.length-1] = {num:finalNum, items:[[1,"Rounding Breads", centavos]], gross:centavos, rounding:true};
  }

  // --- Render ---
  const wrap=$("#receipts"); wrap.innerHTML="";
  receipts.forEach((r,idx)=>{
    if(!r.items || r.items.length===0) return;
    const card=document.createElement("div");
    card.className="receipt-card"+(r.rounding?" rounding":"");
    const header=document.createElement("div");
    header.className="receipt-header";
    header.textContent = r.rounding?`üî∂ Receipt ${r.num} (Rounding)`: `Receipt ${r.num}${r.cake?" ‚Äî Cake Only":""}`;
    card.appendChild(header);
    let grossCheck=0;
    r.items.forEach(it=>{
      const row=document.createElement("div");
      row.className="row-line";
      let lineTotal = it[0]*it[2];
      grossCheck+=lineTotal;
      row.textContent=`${it[0]} √ó ${it[1]} ‚Äì ‚Ç±${it[2]} = ‚Ç±${lineTotal.toFixed(2)}`;
      card.appendChild(row);
    });
    r.gross = grossCheck;
    const vat=vatFromGross(r.gross), net=netFromGross(r.gross);
    card.innerHTML+=`<div class="row-line">Less: VAT (12%) = ${money(vat)}</div>`;
    card.innerHTML+=`<div class="row-line">Net of VAT = ${money(net)}</div>`;
    card.innerHTML+=`<div class="row-line"><b>Gross Total: ${money(r.gross)}</b></div>`;
    wrap.appendChild(card);
  });

  // --- Summary ---
  const totalGross = receipts.reduce((S,r)=>S+r.gross,0);
  const summary=document.createElement("div");
  summary.className="summary-card";
  const diffFinal=+(totalGross - target).toFixed(2);
  summary.innerHTML=`PROJECT SUMMARY<br>Receipts Requested: ${count}<br>Receipts Generated: ${receipts.length}<br>Target Gross: ${money(target)}<br>Grand Gross: ${money(totalGross)}<br>Difference: ${diffFinal>0?"+":""}${money(diffFinal)}`;
  $("#receipts").appendChild(summary);
}
// ===== Copy / Print / Report =====
function copyAll(){
  const text = $("#receipts").innerText.trim();
  if(!text){ alert("No receipts"); return; }
  navigator.clipboard.writeText(text).then(()=>alert("‚úÖ Copied!"));
}
function printPDF(){ window.print(); }
function reportIssue(){
  if(!projectSummary){ alert("No summary yet"); return; }
  const blob = new Blob([projectSummary], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "project_summary.txt"; a.click();
}

// ===== Bindings =====
$("#genBtn").onclick = generate;
$("#copyBtn").onclick = copyAll;
$("#printBtn").onclick = printPDF;
$("#reportBtn").onclick = reportIssue;
$("#menuBtn").onclick = openMenu;
document.getElementById("searchBox").addEventListener("input", e => renderPriceAdjust(e.target.value));
</script>

<!-- What's New Modal -->
<div id="whatsNewModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>What's new?</h3>
    <ul>
      <li>‚Ä¢ Common bug fixes</li>
      <ul>
        <li>Added a new Feature for large Reciepts count</li>
    </ul>
    <button onclick="closeWhatsNew()" class="btn">Cool!</button>
  </div>
</div>

<script>
function showWhatsNew(){
  document.getElementById("whatsNewModal").style.display = "flex";
}
function closeWhatsNew(){
  document.getElementById("whatsNewModal").style.display = "none";
}
window.addEventListener("load", function(){
  showWhatsNew();
});
</script>

</body>
</html>
